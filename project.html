<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Проект реструктуризации ГК → Family Office</title>
<style>
:root {
  --bg:#0D0B0E;--bg2:#141118;--card:#1A1620;--card2:#231E2A;
  --border:#2D2735;--text:#E8E4ED;--text2:#9B95A3;--text3:#6B6573;
  --gold:#C9A44C;--gold2:#A88A3A;--green:#3DB86A;--green2:#2D8A4F;
  --red:#D44040;--red2:#A33030;--blue:#4A8FE0;--blue2:#3A6FB0;
  --purple:#8B5CF6;--orange:#E89B3A;--cyan:#38BDF8;
  --radius:10px;--shadow:0 4px 24px rgba(0,0,0,.4);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
#sidebar{width:260px;min-width:260px;background:var(--bg2);border-right:1px solid var(--border);padding:20px 0;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100}
#sidebar h1{font-size:14px;padding:0 20px 16px;color:var(--gold);border-bottom:1px solid var(--border);margin-bottom:12px;font-weight:600;line-height:1.4}
.nav-group{padding:0 12px;margin-bottom:8px}
.nav-group-title{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);padding:8px 8px 4px}
.nav-btn{display:block;width:100%;text-align:left;background:none;border:none;color:var(--text2);font-size:13px;padding:8px 12px;border-radius:6px;cursor:pointer;transition:all .2s}
.nav-btn:hover{background:var(--card);color:var(--text)}
.nav-btn.active{background:var(--card2);color:var(--gold);font-weight:600}
.nav-btn .badge{display:inline-block;font-size:10px;background:var(--card2);color:var(--text3);padding:1px 6px;border-radius:10px;margin-left:6px}
#sidebar-footer{margin-top:auto;padding:12px 20px;border-top:1px solid var(--border)}
#sidebar-footer button{width:100%;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text2);cursor:pointer;font-size:12px;margin-bottom:6px;transition:all .2s}
#sidebar-footer button:hover{border-color:var(--gold);color:var(--gold)}
#main{margin-left:260px;flex:1;padding:32px;overflow-x:hidden}
.section{display:none;animation:fadeIn .3s ease}
.section.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.section-header{margin-bottom:28px}
.section-header h2{font-size:26px;font-weight:700;margin-bottom:6px}
.section-header p{font-size:14px;color:var(--text2);line-height:1.5}
.section-header .tag{display:inline-block;font-size:11px;background:var(--card2);color:var(--gold);padding:3px 10px;border-radius:12px;margin-right:6px;margin-top:8px}

/* === DASHBOARD === */
.dash-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.dash-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;text-align:center;transition:all .3s}
.dash-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.dash-card .dc-value{font-size:32px;font-weight:800;margin-bottom:4px}
.dash-card .dc-label{font-size:12px;color:var(--text2)}
.dash-card .dc-sub{font-size:10px;color:var(--text3);margin-top:4px}
.dash-progress{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.dash-progress h3{font-size:16px;margin-bottom:16px}
.progress-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.progress-row .pr-label{width:200px;font-size:12px;color:var(--text2);flex-shrink:0}
.progress-row .pr-bar-bg{flex:1;height:20px;background:var(--bg);border-radius:10px;overflow:hidden;position:relative}
.progress-row .pr-bar{height:100%;border-radius:10px;transition:width .8s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:10px;font-weight:700;color:#000;min-width:24px}
.progress-row .pr-pct{width:40px;text-align:right;font-size:12px;font-weight:700;flex-shrink:0}
.dash-timeline{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.dash-timeline h3{font-size:16px;margin-bottom:16px}
.timeline-track{display:flex;align-items:center;position:relative;padding:20px 0}
.timeline-line{position:absolute;top:50%;left:0;right:0;height:3px;background:var(--border);transform:translateY(-50%)}
.timeline-point{position:relative;flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;z-index:1}
.timeline-dot{width:16px;height:16px;border-radius:50%;border:3px solid var(--border);background:var(--bg);transition:all .3s}
.timeline-dot.active{border-color:var(--gold);background:var(--gold);box-shadow:0 0 12px rgba(201,164,76,.5)}
.timeline-dot.done{border-color:var(--green);background:var(--green)}
.timeline-label{font-size:10px;color:var(--text3);text-align:center;max-width:80px}

/* === SVG TREE === */
.tree-viewport{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);position:relative;min-height:400px}
.tree-scroll{overflow:auto;height:100%}
.tree-svg{position:absolute;top:0;left:0;pointer-events:none}
.tree-svg line{stroke:var(--border);stroke-width:2}
.tree-svg path{stroke:var(--border);stroke-width:2.5;fill:none;stroke-linecap:round}
.tree-nodes{position:relative}
.tn{position:absolute;background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:12px 16px;text-align:center;cursor:pointer;transition:all .2s;z-index:2;min-width:140px}
.tn:hover{transform:scale(1.06);box-shadow:0 6px 32px rgba(0,0,0,.5);z-index:3;border-color:var(--gold)}
.tn .tn-title{font-size:13px;font-weight:700;white-space:nowrap}
.tn .tn-sub{font-size:11px;color:var(--text2);margin-top:3px}
.tn .tn-people{font-size:10px;color:var(--text3);margin-top:4px}
.tn .tn-badge{position:absolute;top:-8px;right:-8px;font-size:9px;padding:2px 8px;border-radius:8px;font-weight:700}
.tree-controls{position:absolute;top:10px;right:10px;z-index:5;display:flex;gap:4px}
.tree-controls button{width:32px;height:32px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.tree-controls button:hover{border-color:var(--gold);color:var(--gold)}
.tree-inner{transform-origin:0 0;transition:transform .2s}
.tn.c-gold{border-color:var(--gold2);background:linear-gradient(135deg,#1A1620,#2A2030)}
.tn.c-gold .tn-title{color:var(--gold)}
.tn.c-red{border-color:var(--red2)}
.tn.c-green{border-color:var(--green2)}
.tn.c-blue{border-color:var(--blue2)}
.tn.c-purple{border-color:var(--purple)}
.tn.c-orange{border-color:var(--orange)}
.tn.c-cyan{border-color:var(--cyan)}
.badge-income{background:var(--green2);color:#fff}
.badge-renovation{background:var(--orange);color:#000}
.badge-construction{background:var(--blue2);color:#fff}

/* === TABLES === */
.data-table{width:100%;border-collapse:collapse;margin-top:12px}
.data-table th{background:var(--card2);color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:1px;padding:10px 12px;text-align:left;border-bottom:1px solid var(--border)}
.data-table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:top}
.data-table tr:hover td{background:var(--card)}
.data-table td[contenteditable="true"]{cursor:text}
.data-table td[contenteditable="true"]:focus{outline:1px solid var(--gold);border-radius:3px}
.raci-cell{text-align:center;font-weight:700;font-size:14px;cursor:pointer;user-select:none}
.raci-R{color:var(--green)}.raci-A{color:var(--gold)}.raci-C{color:var(--blue)}.raci-I{color:var(--text3)}

/* === GANTT v3 === */
.gantt-wrap{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.gantt-toolbar{display:flex;gap:8px;padding:12px;background:var(--card2);border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center}
.gantt-toolbar button,.gantt-toolbar label{padding:5px 12px;border-radius:5px;border:1px solid var(--border);background:var(--card);color:var(--text2);cursor:pointer;font-size:11px;transition:all .2s}
.gantt-toolbar button:hover,.gantt-toolbar label:hover{border-color:var(--gold);color:var(--gold)}
.gantt-toolbar button.active{border-color:var(--gold);color:var(--gold);background:var(--card2)}
.gantt-scroll{overflow-x:auto;overflow-y:auto;max-height:70vh}
.gantt-grid{display:grid;min-width:1400px}
.gantt-corner{background:var(--card2);border-right:1px solid var(--border);border-bottom:2px solid var(--border);padding:8px;font-size:10px;color:var(--text3);position:sticky;left:0;z-index:4}
.gantt-mh{background:var(--card2);border-bottom:2px solid var(--border);border-right:1px solid rgba(45,39,53,.3);padding:6px 2px;font-size:10px;color:var(--text3);text-align:center;font-weight:600}
.gantt-mh.milestone{position:relative}
.gantt-mh.milestone::after{content:'';position:absolute;bottom:-1px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid var(--gold)}
.gantt-label{background:var(--bg2);border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:6px 10px;font-size:11px;position:sticky;left:0;z-index:3;display:flex;align-items:center;gap:6px}
.gantt-label.phase-row{background:var(--card2);font-weight:700;font-size:12px;color:var(--text)}
.gantt-label .gl-name{flex:1;white-space:normal;line-height:1.3}
.gantt-label .gl-owner{font-size:9px;color:var(--text3);white-space:nowrap}
.gantt-label .gl-progress{font-size:9px;font-weight:700;white-space:nowrap}
.gantt-cell{border-right:1px solid rgba(45,39,53,.3);border-bottom:1px solid var(--border);position:relative;min-height:32px}
.gantt-cell.phase-row{background:var(--card2)}
.gantt-cell.today{background:rgba(201,164,76,.08)}
.g-bar{position:absolute;top:5px;bottom:5px;border-radius:4px;cursor:grab;transition:opacity .15s;display:flex;align-items:center;justify-content:center;font-size:9px;color:rgba(255,255,255,.8);font-weight:600;overflow:hidden;min-width:12px;user-select:none}
.g-bar:hover{opacity:.85;z-index:2}
.g-bar:active{cursor:grabbing}
.g-bar .g-resize{position:absolute;right:0;top:0;bottom:0;width:8px;cursor:ew-resize;background:rgba(255,255,255,.1);border-radius:0 4px 4px 0}
.g-bar .g-resize:hover{background:rgba(255,255,255,.25)}
.g-bar .g-progress-fill{position:absolute;left:0;top:0;bottom:0;background:rgba(255,255,255,.2);border-radius:4px 0 0 4px;pointer-events:none}
.g-bar.p0{background:var(--text3)}.g-bar.p1{background:var(--green)}.g-bar.p2{background:var(--blue)}
.g-bar.p3{background:var(--purple)}.g-bar.p4{background:var(--orange)}.g-bar.p5{background:var(--gold)}.g-bar.p6{background:var(--cyan)}
.gantt-add-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 4px;transition:color .2s}
.gantt-add-btn:hover{color:var(--green)}
.gantt-move-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:10px;padding:0 1px;transition:color .2s;line-height:1}
.gantt-move-btn:hover{color:var(--gold)}
.gantt-mh.editable{cursor:pointer}
.gantt-mh.editable:hover{color:var(--gold)}

/* === RISK REGISTER === */
.risk-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
.risk-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:all .2s}
.risk-card:hover{border-color:var(--gold)}
.risk-card .rc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.risk-card .rc-title{font-size:14px;font-weight:600}
.risk-card .rc-level{font-size:10px;padding:2px 8px;border-radius:8px;font-weight:700}
.rc-level.high{background:rgba(212,64,64,.2);color:var(--red)}
.rc-level.medium{background:rgba(232,155,58,.2);color:var(--orange)}
.rc-level.low{background:rgba(61,184,106,.2);color:var(--green)}
.risk-card .rc-desc{font-size:12px;color:var(--text2);margin-bottom:8px;line-height:1.5}
.risk-card .rc-mitigation{font-size:12px;color:var(--green);line-height:1.5}
.risk-card .rc-mitigation::before{content:'Митигация: ';font-weight:600}
.risk-matrix{display:grid;grid-template-columns:auto repeat(3,80px);gap:2px;margin-bottom:24px;max-width:380px}
.risk-matrix .rm-cell{height:60px;display:flex;align-items:center;justify-content:center;font-size:11px;border-radius:4px;font-weight:600;text-align:center;padding:4px}
.rm-header{background:var(--card2);color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:.5px}
.rm-high{background:rgba(212,64,64,.25);color:var(--red)}
.rm-medium{background:rgba(232,155,58,.2);color:var(--orange)}
.rm-low{background:rgba(61,184,106,.15);color:var(--green)}

/* === CARDS / BLOCKS === */
.struct-block{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.struct-block h3{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:12px}
.obj-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;transition:all .2s;cursor:pointer}
.obj-card:hover{border-color:var(--gold)}
.budget-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;text-align:center}
.budget-card .budget-amount{font-size:28px;font-weight:700;color:var(--gold)}
.budget-card .budget-label{font-size:12px;color:var(--text2);margin-top:4px}
.budget-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:20px}
.bpmn-canvas{overflow:auto;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;min-height:300px}
.bpmn-node{display:inline-flex;flex-direction:column;align-items:center;background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:12px 16px;text-align:center;cursor:pointer;transition:all .2s;min-width:140px;position:absolute}
.bpmn-node:hover{border-color:var(--gold);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.bpmn-node .bn-name{font-size:12px;font-weight:700;color:var(--text)}
.bpmn-node .bn-owner{font-size:10px;color:var(--text3);margin-top:3px}
.bpmn-node .bn-type{font-size:9px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.bpmn-start,.bpmn-end{width:32px;height:32px;border-radius:50%;position:absolute;display:flex;align-items:center;justify-content:center;font-size:16px}
.bpmn-start{background:var(--green);color:#000}
.bpmn-end{background:var(--red);color:#fff}
.faq-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden}
.faq-q{padding:14px 18px;cursor:pointer;font-size:14px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.faq-q:hover{background:var(--card2)}
.faq-q::after{content:'▸';transition:transform .2s;color:var(--text3)}
.faq-item.open .faq-q::after{transform:rotate(90deg)}
.faq-a{padding:0 18px;max-height:0;overflow:hidden;transition:all .3s;font-size:13px;color:var(--text2);line-height:1.6}
.faq-item.open .faq-a{padding:0 18px 14px;max-height:2000px}
.fw-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:12px}
.fw-card h4{font-size:15px;color:var(--gold);margin-bottom:10px}
.fw-card ul{padding-left:20px;font-size:13px;color:var(--text2);line-height:1.8}
.legend{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0;font-size:11px;color:var(--text2)}
.legend-item{display:flex;align-items:center;gap:5px}
.legend-dot{width:10px;height:10px;border-radius:50%}

/* === MODAL === */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;justify-content:center;align-items:center}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.modal h3{font-size:18px;margin-bottom:16px}
.modal label{font-size:12px;color:var(--text2);display:block;margin-bottom:4px;margin-top:12px}
.modal input,.modal select,.modal textarea{width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px}
.modal textarea{min-height:80px;resize:vertical}
.modal-actions{display:flex;gap:8px;margin-top:20px;justify-content:flex-end;flex-wrap:wrap}
.btn{padding:8px 18px;border-radius:6px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s}
.btn-primary{background:var(--gold);color:#000}
.btn-primary:hover{background:var(--gold2)}
.btn-secondary{background:var(--card);color:var(--text2);border:1px solid var(--border)}
.btn-danger{background:var(--red2);color:#fff}

/* === SYNC & PRESENCE === */
#sync-bar{display:flex;align-items:center;gap:6px;padding:8px 0;font-size:11px;color:var(--text3)}
#sync-bar .sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:background .3s}
#sync-bar.saved .sync-dot{background:var(--green)}
#sync-bar.synced .sync-dot{background:var(--cyan)}
#sync-bar.saving .sync-dot{background:var(--gold);animation:pulse 1s infinite}
#sync-bar.error .sync-dot{background:var(--red)}
#sync-bar.offline .sync-dot{background:var(--orange)}
#sync-bar.connecting .sync-dot{background:var(--text3);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
#presence-panel{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:10px}
#presence-panel .pp-title{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:8px;display:flex;align-items:center;gap:6px}
#presence-panel .pp-count{background:var(--green);color:#000;font-size:9px;font-weight:800;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.presence-user{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px}
.presence-user .pu-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}
.presence-user .pu-name{font-weight:600;font-size:12px}
.presence-user .pu-status{font-size:10px;color:var(--text3)}
.presence-user .pu-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;box-shadow:0 0 6px rgba(61,184,106,.5)}
.presence-user.you .pu-name::after{content:' (ты)';color:var(--text3);font-weight:400;font-size:10px}

/* === PRINT === */
#mobile-toggle{display:none;position:fixed;top:12px;left:12px;z-index:200;background:var(--card2);border:1px solid var(--border);color:var(--gold);width:40px;height:40px;border-radius:8px;font-size:20px;cursor:pointer;line-height:1}
@media(max-width:900px){
  #mobile-toggle{display:block}
  #sidebar{transform:translateX(-100%);transition:transform .3s ease;width:280px}
  #sidebar.open{transform:translateX(0)}
  #main{margin-left:0;padding:16px 12px}
  .section-header h2{font-size:20px}
  .dash-grid{grid-template-columns:repeat(2,1fr)!important;gap:8px!important}
  .dash-card{padding:12px!important}
  .dc-value{font-size:28px!important}
  .gantt-grid{min-width:800px!important}
  .gantt-label{min-width:180px!important;font-size:11px!important;padding:4px 6px!important}
  .data-table{font-size:11px}
  .data-table th,.data-table td{padding:6px 8px}
  .risk-matrix{grid-template-columns:auto repeat(3,60px)}
  .timeline-track{gap:8px}
  .progress-row{flex-wrap:wrap}
  .pr-label{font-size:11px;min-width:100%}
  .tree-viewport{height:400px!important}
}
@media(max-width:480px){
  .dash-grid{grid-template-columns:1fr!important}
  .gantt-label{min-width:140px!important;font-size:10px!important}
  .gantt-toolbar{flex-wrap:wrap;gap:4px}
  .gantt-toolbar button{font-size:10px;padding:4px 8px}
}
@media print{
  #sidebar{display:none}
  #main{margin-left:0;padding:16px}
  .section{display:block!important;page-break-inside:avoid;margin-bottom:32px}
  .tree-controls,.gantt-toolbar,.gantt-add-btn,.modal-overlay{display:none!important}
  .nav-btn,.btn{display:none}
  body{background:#fff;color:#000}
  .data-table th{background:#eee;color:#333}
  .data-table td{border-color:#ccc}
  .dash-card,.risk-card,.faq-item,.fw-card,.struct-block,.budget-card{background:#fff;border-color:#ddd}
  .section-header h2{color:#000}
}
</style>
</head>
<body>
<button id="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">&#9776;</button>
<nav id="sidebar" onclick="if(window.innerWidth<=900&&event.target.classList.contains('nav-btn'))this.classList.remove('open')">
  <h1>Проект реструктуризации<br>ГК → Family Office <span style="font-size:10px;color:var(--text3);font-weight:400">v3.8</span></h1>
  <div class="nav-group">
    <div class="nav-group-title">Обзор</div>
    <button class="nav-btn active" data-section="dashboard">Dashboard</button>
  </div>
  <div class="nav-group">
    <div class="nav-group-title">Структура</div>
    <button class="nav-btn" data-section="asis">AS-IS <span class="badge">текущая</span></button>
    <button class="nav-btn" data-section="transition">Переходная <span class="badge">12 мес</span></button>
    <button class="nav-btn" data-section="target">Целевая <span class="badge">18+ мес</span></button>
    <button class="nav-btn" data-section="delta">Дельта <span class="badge">было→стало</span></button>
  </div>
  <div class="nav-group">
    <div class="nav-group-title">Проект</div>
    <button class="nav-btn" data-section="raci">RACI-матрица</button>
    <button class="nav-btn" data-section="bpmn">Бизнес-процессы</button>
    <button class="nav-btn" data-section="budget">Бюджет (драфт)</button>
    <button class="nav-btn" data-section="risks">Риски</button>
  </div>
  <div class="nav-group">
    <div class="nav-group-title">Защита</div>
    <button class="nav-btn" data-section="faq">FAQ — вопросы и ответы</button>
    <button class="nav-btn" data-section="frameworks">Фреймворки</button>
  </div>
  <div id="sidebar-footer">
    <div id="presence-panel">
      <div class="pp-title">Сейчас онлайн <span class="pp-count" id="pp-count">0</span></div>
      <div id="presence-list"></div>
    </div>
    <div id="sync-bar" class="connecting"><div class="sync-dot"></div><span id="sync-text">Подключение...</span></div>
    <button onclick="exportJSON()">Скачать JSON</button>
    <button onclick="document.getElementById('imp').click()">Загрузить JSON</button>
    <input type="file" id="imp" accept=".json" style="display:none" onchange="importJSON(event)">
    <button onclick="window.print()" style="margin-top:4px">Печать / PDF</button>
  </div>
</nav>

<div id="main">
  <!-- DASHBOARD -->
  <div id="section-dashboard" class="section active">
    <div class="section-header">
      <h2>Dashboard — обзор проекта</h2>
      <p>Ключевые метрики, прогресс по фазам и диаграмма Ганта.</p>
    </div>
    <div id="dashboard-content"></div>
    <div style="margin-top:24px">
      <div id="gantt-content"></div>
    </div>
  </div>

  <!-- AS-IS -->
  <div id="section-asis" class="section">
    <div class="section-header">
      <h2>Текущая структура (AS-IS)</h2>
      <p>Управление по объектам. Одни и те же люди дублируются в каждом объекте — перегрузка ГК Траст.</p>
      <span class="tag">Источник: Структура управления В-Н.docx</span>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--gold)"></div> Собственники</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div> Контроль (Траст)</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div> Никита</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div> Владимир</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div> Совместные</div>
    </div>
    <div id="tree-asis" class="tree-viewport" style="height:620px"></div>
  </div>

  <!-- TRANSITION -->
  <div id="section-transition" class="section">
    <div class="section-header">
      <h2>Переходная структура (12 месяцев)</h2>
      <p>Управление по функциям: Никита = доход, Владимир = проекты. Траст — контроль.</p>
      <span class="tag">Galbraith Star Model</span><span class="tag">Kotter Step 2-5</span>
    </div>
    <div id="tree-transition" class="tree-viewport" style="height:520px"></div>
  </div>

  <!-- TARGET -->
  <div id="section-target" class="section">
    <div class="section-header">
      <h2>Целевая структура — Family Office (18+ месяцев)</h2>
      <p>Институциональная модель: Family Council → Инвесткомитет → CEO FO → 4 блока.</p>
      <span class="tag">Family Office</span><span class="tag">Инвестиционная платформа</span>
    </div>
    <div id="tree-target" class="tree-viewport" style="height:560px"></div>
  </div>

  <!-- DELTA -->
  <div id="section-delta" class="section">
    <div class="section-header"><h2>Дельта: было → стало</h2><p>Кликните на ячейку для редактирования. Изменения сохраняются в JSON.</p></div>
    <div id="delta-content"></div>
  </div>

  <!-- GANTT moved into Dashboard -->

  <!-- RACI -->
  <div id="section-raci" class="section">
    <div class="section-header"><h2>RACI-матрица</h2><p>Клик по ячейке: R → A → C → I. A всегда один — иначе конфликты.</p></div>
    <div id="raci-content"></div>
  </div>

  <!-- BPMN -->
  <div id="section-bpmn" class="section">
    <div class="section-header"><h2>Бизнес-процессы</h2><p>Карта ключевых процессов с ответственными из RACI. Клик на блок — перейти к процессу.</p></div>
    <div id="bpmn-content"></div>
  </div>

  <!-- BUDGET -->
  <div id="section-budget" class="section">
    <div class="section-header"><h2>Бюджет реструктуризации (драфт)</h2><p>Затраты по фазам. Двойной клик на сумму для редактирования.</p></div>
    <div style="background:rgba(201,164,76,0.1);border:1px solid var(--gold);border-radius:8px;padding:12px 16px;margin-bottom:20px;font-size:13px;color:var(--gold)"><strong>Предварительная оценка</strong> — цифры требуют обоснования (КП подрядчиков, рыночные зарплаты, стоимость лицензий). Финальный бюджет формируется в рамках соответствующих фаз.</div>
    <div id="budget-content"></div>
  </div>

  <!-- RISKS -->
  <div id="section-risks" class="section">
    <div class="section-header"><h2>Реестр рисков</h2><p>Идентифицированные риски с оценкой и стратегией митигации. Критично для защиты проекта.</p></div>
    <div id="risks-content"></div>
  </div>

  <!-- FAQ -->
  <div id="section-faq" class="section">
    <div class="section-header"><h2>FAQ — вопросы для защиты</h2><p>Предугаданные вопросы собственников.</p></div>
    <div id="faq-content"></div>
  </div>

  <!-- FRAMEWORKS -->
  <div id="section-frameworks" class="section">
    <div class="section-header"><h2>Используемые фреймворки</h2></div>
    <div id="frameworks-content"></div>
  </div>
</div>

<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal"></div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const STATE = {
  // ---------- TREE DATA ----------
  trees: {
    asis: {
      id:'root', label:'Собственники', sub:'АН + ПВ', color:'c-gold', children:[
        { id:'trust', label:'ГК ТРАСТ', sub:'Контроль и комплаенс', color:'c-red', children:[
          { id:'t1', label:'Бухгалтерия', sub:'Татьяна В.', color:'c-red' },
          { id:'t2', label:'Юридический', sub:'Влад, Андрей', color:'c-red' },
          { id:'t3', label:'Экономика', sub:'Екатерина', color:'c-red' },
          { id:'t4', label:'Кадры', sub:'Наталья Т.', color:'c-red' },
          { id:'t5', label:'Безопасность', sub:'Алексей П.', color:'c-red' },
          { id:'t6', label:'IT', sub:'Павел Э., Константин', color:'c-red' }
        ]},
        { id:'nikita', label:'Никита', sub:'Руководитель направления', color:'c-green', children:[
          { id:'n1', label:'Люсиновская', sub:'12 900 м²', color:'c-green', badge:'Доход', badgeCls:'badge-income' },
          { id:'n2', label:'Никитина 20', sub:'3 900 м²', color:'c-orange', badge:'Ремонт', badgeCls:'badge-renovation' },
          { id:'n3', label:'Никитина 20/2', sub:'3 400 м²', color:'c-orange', badge:'Ремонт', badgeCls:'badge-renovation' },
          { id:'n4', label:'Земля Никитина', sub:'15 соток', color:'c-blue', badge:'Стройка', badgeCls:'badge-construction' },
          { id:'n5', label:'Планета-05', sub:'1 300 м²', color:'c-green', badge:'Доход', badgeCls:'badge-income' },
          { id:'n6', label:'Квартиры', sub:'18 + 4 объекта', color:'c-green', badge:'Доход', badgeCls:'badge-income' },
          { id:'n7', label:'Поиск бизнесов', sub:'Стратегия', color:'c-green' }
        ]},
        { id:'vladimir', label:'Владимир', sub:'Руководитель направления', color:'c-blue', children:[
          { id:'v1', label:'Элкопром', sub:'7 620 м²', color:'c-blue', badge:'Доход', badgeCls:'badge-income' },
          { id:'v2', label:'БЦ Кубик', sub:'1 300 м²', color:'c-blue', badge:'Доход', badgeCls:'badge-income' },
          { id:'v3', label:'Тулинская', sub:'1 000 м²', color:'c-blue', badge:'Доход', badgeCls:'badge-income' },
          { id:'v4', label:'КП Сочи', sub:'31 дом, 150 сот.', color:'c-blue', badge:'Стройка', badgeCls:'badge-construction' },
          { id:'v5', label:'Стройка Земля', sub:'5 участков', color:'c-blue', badge:'Стройка', badgeCls:'badge-construction' },
          { id:'v6', label:'УК Империя', sub:'Управление', color:'c-blue' }
        ]},
        { id:'shared', label:'Maison Rouge', sub:'Ресторан (совместно)', color:'c-purple' }
      ]
    },
    transition: {
      id:'root', label:'Собственники', sub:'АН + ПВ (стратегия)', color:'c-gold', children:[
        { id:'mgmt', label:'Управляющая команда', sub:'Никита + Владимир', color:'c-green', children:[
          { id:'ops', label:'Операции / Доход', sub:'Никита — NOI, аренда', color:'c-green', children:[
            { id:'o1', label:'Люсиновская', sub:'12 900 м²', color:'c-green' },
            { id:'o2', label:'Планета-05', sub:'1 300 м²', color:'c-green' },
            { id:'o3', label:'Квартиры', sub:'22 объекта', color:'c-green' },
            { id:'o4', label:'Элкопром', sub:'7 620 м²', color:'c-green' },
            { id:'o5', label:'БЦ Кубик', sub:'1 300 м²', color:'c-green' },
            { id:'o6', label:'Тулинская', sub:'1 000 м²', color:'c-green' }
          ]},
          { id:'proj', label:'Проекты / Стройка', sub:'Владимир — сроки, бюджет', color:'c-blue', children:[
            { id:'p1', label:'Капремонт Люсин.', sub:'~3 500 м²', color:'c-blue' },
            { id:'p2', label:'Капремонт Ник.20', sub:'~3 900 м²', color:'c-blue' },
            { id:'p3', label:'Капремонт Ник.20/2', sub:'~3 400 м²', color:'c-blue' },
            { id:'p4', label:'Капремонт Элкопр.', sub:'~7 620 м²', color:'c-blue' },
            { id:'p5', label:'КП Сочи', sub:'31 дом', color:'c-blue' },
            { id:'p6', label:'Стройки Земля', sub:'Все участки', color:'c-blue' }
          ]},
          { id:'inv', label:'Инвестиции', sub:'Совместно', color:'c-purple' }
        ]},
        { id:'trust2', label:'ГК ТРАСТ', sub:'Контроль (не управляет)', color:'c-red', children:[
          { id:'tr1', label:'Бухгалтерия', sub:'Централизованная', color:'c-red' },
          { id:'tr2', label:'Юристы', sub:'Централизованные', color:'c-red' },
          { id:'tr3', label:'Финконтроль', sub:'Екатерина', color:'c-red' },
          { id:'tr4', label:'Кадры + СБ + IT', sub:'Централизованные', color:'c-red' }
        ]}
      ]
    },
    target: {
      id:'root', label:'Семья', sub:'АН + ПВ', color:'c-gold', children:[
        { id:'council', label:'Family Council', sub:'АН, ПВ, Никита, Владимир', color:'c-gold' },
        { id:'committee', label:'Инвестиционный комитет', sub:'Стратегические решения', color:'c-gold' },
        { id:'ceo', label:'CEO Family Office', sub:'Никита / Владимир', color:'c-green', children:[
          { id:'im', label:'Investment Mgmt', sub:'Капитал • 2-3 чел.', color:'c-purple', children:[
            { id:'im1', label:'Покупка/продажа', color:'c-purple' },
            { id:'im2', label:'Портфельная стратегия', color:'c-purple' },
            { id:'im3', label:'Аналитика', color:'c-purple' }
          ]},
          { id:'am', label:'Asset Mgmt', sub:'Активы • 4-6 чел.', color:'c-green', children:[
            { id:'am1', label:'Доход объектов', color:'c-green' },
            { id:'am2', label:'Арендаторы', color:'c-green' },
            { id:'am3', label:'Заполняемость', color:'c-green' }
          ]},
          { id:'dev', label:'Development', sub:'Девелопмент • 3-5 чел.', color:'c-blue', children:[
            { id:'d1', label:'Стройка', color:'c-blue' },
            { id:'d2', label:'Реконструкции', color:'c-blue' },
            { id:'d3', label:'Ввод объектов', color:'c-blue' }
          ]},
          { id:'sup', label:'FO Support', sub:'Поддержка • 3-5 чел.', color:'c-red', children:[
            { id:'s1', label:'Финансы', color:'c-red' },
            { id:'s2', label:'Юристы', color:'c-red' },
            { id:'s3', label:'Комплаенс', color:'c-red' }
          ]}
        ]}
      ]
    }
  },

  // ---------- DELTA ----------
  delta: {
    people: [
      { name:'Татьяна Викторовна', asIs:'Гл.бухгалтер — дублируется по объектам', transition:'Централизованная бухгалтерия (ТРАСТ)', target:'FO Support → Финансы' },
      { name:'Влад', asIs:'Юрист — дублируется по объектам', transition:'Централизованный юр.блок', target:'FO Support → Юристы' },
      { name:'Андрей (юрист)', asIs:'Юрист — дублируется по объектам', transition:'Централизованный юр.блок', target:'FO Support → Юристы' },
      { name:'Екатерина', asIs:'Экономист — дублируется по объектам', transition:'Централизованный фин.контроль', target:'FO Support → Фин.аналитик' },
      { name:'Наталья Тарасова', asIs:'Кадры — дублируется по объектам', transition:'Централизованные кадры', target:'FO Support → HR' },
      { name:'Алексей Петрович', asIs:'СБ — дублируется по объектам', transition:'Единая служба безопасности', target:'FO Support → Безопасность' },
      { name:'Иван', asIs:'Аренда/эксплуатация (несколько объектов)', transition:'Блок Операций → управляющий кластером', target:'Asset Mgmt → управляющий' },
      { name:'Алексей (инженер)', asIs:'Гл.инженер Люсиновская+Никитина', transition:'Руководитель эксплуатации', target:'Asset Mgmt → техн.экспл.' },
      { name:'Павел Эдуардович', asIs:'IT ГК Траст', transition:'IT + автоматизация', target:'FO Support → IT' },
      { name:'Никита', asIs:'Руководитель направления (всё)', transition:'Управл.команда → Доход', target:'CEO FO / Investment' },
      { name:'Владимир', asIs:'Руководитель направления (всё)', transition:'Управл.команда → Проекты', target:'CEO FO / Development' }
    ],
    objects: [
      { name:'Люсиновская (12 900 м²)', asIs:'Никита → свои люди', transition:'Операции (Никита)', target:'Asset Management' },
      { name:'Никитина 20 (3 900 м²)', asIs:'Никита → капремонт', transition:'Проекты (Владимир) → Операции', target:'Asset Mgmt (после ремонта)' },
      { name:'Никитина 20/2 (3 400 м²)', asIs:'Никита → капремонт', transition:'Проекты (Владимир) → Операции', target:'Asset Mgmt (после ремонта)' },
      { name:'Земля Никитина (15 сот.)', asIs:'Никита → строительство', transition:'Проекты (Владимир)', target:'Development → Asset Mgmt' },
      { name:'Планета-05 (1 300 м²)', asIs:'Никита', transition:'Операции (Никита)', target:'Asset Management' },
      { name:'Квартиры (22 шт)', asIs:'Никита → Ольга, Мария', transition:'Операции (Никита)', target:'Asset Management' },
      { name:'Элкопром (7 620 м²)', asIs:'Владимир → свои люди', transition:'Операции (Никита) + капремонт (Владимир)', target:'Asset Management' },
      { name:'БЦ Кубик (1 300 м²)', asIs:'Владимир → Иван', transition:'Операции (Никита)', target:'Asset Management' },
      { name:'Тулинская (1 000 м²)', asIs:'Владимир → Иван', transition:'Операции (Никита)', target:'Asset Management' },
      { name:'КП Сочи (31 дом)', asIs:'Владимир → Слава, Дмитрий', transition:'Проекты (Владимир)', target:'Development' },
      { name:'Maison Rouge', asIs:'Совместно (Никита+АН+Владимир)', transition:'Доп.проект руководства', target:'Отдельное управление' }
    ]
  },

  // ---------- GANTT ----------
  gantt: {
    months:['М1','М2','М3','М4','М5','М6','М7','М8','М9','М10','М11','М12','М13','М14','М15','М16','М17','М18'],
    milestones:[
      {month:0, label:'Старт'},
      {month:2, label:'Прозрачность'},
      {month:4, label:'Портфель'},
      {month:7, label:'Стабилизация'},
      {month:11, label:'Команда'},
      {month:17, label:'Family Office'}
    ],
    showDeps: false,
    phases:[
      { name:'Фаза 0: Подготовка', cls:'p0', tasks:[
        { name:'Утверждение структуры собственниками', owner:'АН + ПВ', s:0, d:1, progress:0, deps:[] },
        { name:'Коммуникация команде', owner:'Никита + Владимир', s:0, d:1, progress:0, deps:[[0,0]] },
        { name:'Назначение управляющей команды', owner:'АН + ПВ', s:0, d:1, progress:0, deps:[[0,0]] }
      ]},
      { name:'Фаза 1: Прозрачность (0-2 мес)', cls:'p1', tasks:[
        { name:'Консолидированный cash-flow', owner:'Екатерина + Татьяна В.', s:0, d:2, progress:0, deps:[[0,2]] },
        { name:'Доход/расход по каждому объекту', owner:'Екатерина', s:0, d:2, progress:0, deps:[[0,2]] },
        { name:'Реестр арендаторов + заполняемость', owner:'Иван', s:0, d:1, progress:0, deps:[] },
        { name:'Классификация объектов: доход/ремонт/стройка', owner:'Никита + Владимир', s:1, d:1, progress:0, deps:[[1,0],[1,1]] },
        { name:'Запуск еженедельного совещания', owner:'Никита + Владимир', s:0, d:1, progress:0, deps:[[0,1]] },
        { name:'Фиксация всех проектов + бюджеты + сроки', owner:'Владимир', s:0, d:2, progress:0, deps:[[0,2]] }
      ]},
      { name:'Фаза 2: Портфельное управление (2-4 мес)', cls:'p2', tasks:[
        { name:'P&L по каждому объекту', owner:'Екатерина', s:2, d:2, progress:0, deps:[[1,0],[1,1]] },
        { name:'План роста доходности по объектам', owner:'Никита', s:2, d:2, progress:0, deps:[[1,3]] },
        { name:'Графики + бюджеты всех строек', owner:'Владимир', s:2, d:2, progress:0, deps:[[1,5]] },
        { name:'Перераспределение задач (снять перегрузку)', owner:'Никита + Владимир', s:2, d:2, progress:0, deps:[[1,3]] },
        { name:'Разделение зон: Никита=доход, Владимир=проекты', owner:'Никита + Владимир', s:2, d:1, progress:0, deps:[[0,2]] },
        { name:'Первый ежемесячный отчёт собственникам', owner:'Управл.команда', s:2, d:1, progress:0, deps:[[2,0]] }
      ]},
      { name:'Фаза 3: Новая система (3-4 мес)', cls:'p3', tasks:[
        { name:'KPI объектов (NOI, заполняемость, ставки)', owner:'Никита', s:3, d:1, progress:0, deps:[[2,0]] },
        { name:'KPI проектов (сроки, бюджеты, ROI)', owner:'Владимир', s:3, d:1, progress:0, deps:[[2,2]] },
        { name:'Портфельная отчётность', owner:'Екатерина', s:3, d:2, progress:0, deps:[[3,0],[3,1]] },
        { name:'Определение будущих руководителей', owner:'Никита + Владимир', s:3, d:2, progress:0, deps:[[2,3]] },
        { name:'Выбор системы автоматизации', owner:'Павел Э.', s:3, d:2, progress:0, deps:[] },
        { name:'Финансовый план портфеля на год', owner:'Екатерина + Никита', s:3, d:1, progress:0, deps:[[3,2]] }
      ]},
      { name:'Фаза 4: Стабилизация (4-7 мес)', cls:'p4', tasks:[
        { name:'Централизация бухгалтерии', owner:'Татьяна В.', s:4, d:3, progress:0, deps:[[2,4]] },
        { name:'Централизация юридического блока', owner:'Влад', s:4, d:3, progress:0, deps:[[2,4]] },
        { name:'Централизация HR', owner:'Наталья Тарасова', s:4, d:2, progress:0, deps:[[2,4]] },
        { name:'Единая служба эксплуатации', owner:'Алексей (инженер)', s:4, d:3, progress:0, deps:[[2,3]] },
        { name:'Разделение операционки и проектов по объектам', owner:'Никита + Владимир', s:4, d:3, progress:0, deps:[[2,4]] },
        { name:'Регламенты и стандарты управления', owner:'Никита', s:5, d:2, progress:0, deps:[[4,0],[4,1]] },
        { name:'Внедрение IT-системы', owner:'Павел Э.', s:4, d:3, progress:0, deps:[[3,4]] },
        { name:'Запуск инвесткомитета (ежеквартально)', owner:'АН + ПВ', s:6, d:1, progress:0, deps:[[4,5]] }
      ]},
      { name:'Фаза 5: Формирование команды (7-12 мес)', cls:'p5', tasks:[
        { name:'Найм руководителя Asset Management', owner:'Никита', s:7, d:3, progress:0, deps:[[3,3]] },
        { name:'Найм руководителя Development', owner:'Владимир', s:7, d:3, progress:0, deps:[[3,3]] },
        { name:'Найм финансового аналитика', owner:'Екатерина', s:8, d:2, progress:0, deps:[[3,5]] },
        { name:'Передача операционки от Никиты', owner:'Никита', s:9, d:3, progress:0, deps:[[5,0]] },
        { name:'Передача проектов от Владимира', owner:'Владимир', s:9, d:3, progress:0, deps:[[5,1]] },
        { name:'Обучение руководителей стандартам', owner:'Никита + Владимир', s:10, d:2, progress:0, deps:[[5,3],[5,4]] },
        { name:'Family Council — первое заседание', owner:'АН + ПВ', s:11, d:1, progress:0, deps:[[5,5]] }
      ]},
      { name:'Фаза 6: Family Office (13-18 мес)', cls:'p6', tasks:[
        { name:'Формирование Investment Management блока', owner:'Никита', s:12, d:3, progress:0, deps:[[5,6]] },
        { name:'Формирование FO Support блока', owner:'Никита + Владимир', s:12, d:3, progress:0, deps:[[5,6]] },
        { name:'Назначение CEO Family Office', owner:'АН + ПВ', s:13, d:2, progress:0, deps:[[6,0],[6,1]] },
        { name:'Полный выход из операционки', owner:'Никита + Владимир', s:14, d:3, progress:0, deps:[[6,2]] },
        { name:'Внешний аудит системы', owner:'Консультант', s:15, d:2, progress:0, deps:[[6,3]] },
        { name:'Корректировка по результатам аудита', owner:'CEO FO', s:16, d:2, progress:0, deps:[[6,4]] },
        { name:'Утверждение финальной структуры', owner:'АН + ПВ', s:17, d:1, progress:0, deps:[[6,5]] }
      ]}
    ]
  },

  // ---------- RACI ----------
  raci: {
    roles:['АН+ПВ','Никита','Владимир','ТРАСТ','Рук-ли'],
    processes:[
      { name:'Поиск новых объектов', v:['C','R','R','I','I'] },
      { name:'Финансовый анализ сделки', v:['I','A','C','R','I'] },
      { name:'Решение о покупке', v:['A','R','R','C','I'] },
      { name:'Продажа активов', v:['A','C','C','R','I'] },
      { name:'Стратегия портфеля', v:['A','R','R','C','I'] },
      { name:'Заполняемость объектов', v:['I','A','I','I','R'] },
      { name:'Арендные ставки', v:['I','A','I','C','R'] },
      { name:'Управление арендаторами', v:['I','A','I','C','R'] },
      { name:'Сервис и эксплуатация', v:['I','A','C','I','R'] },
      { name:'План проекта (стройка)', v:['I','C','A','I','R'] },
      { name:'Выбор подрядчиков', v:['I','C','A','I','R'] },
      { name:'Бюджет проекта', v:['I','C','A','R','I'] },
      { name:'Контроль сроков стройки', v:['I','I','A','I','R'] },
      { name:'Ввод в эксплуатацию', v:['I','C','A','I','R'] },
      { name:'Консолидированная отчётность', v:['A','C','C','R','I'] },
      { name:'Контроль бюджета', v:['A','C','C','R','I'] },
      { name:'Комплаенс', v:['A','I','I','R','I'] },
      { name:'Баланс портфеля', v:['A','R','R','C','I'] },
      { name:'Перераспределение капитала', v:['A','R','R','C','I'] }
    ]
  },

  budget: {
    phases:[
      { name:'Фаза 0-1: Подготовка + прозрачность', months:'0-2', items:[{name:'Внутренние ресурсы',cost:0}], total:0 },
      { name:'Фаза 2-3: Управление + система', months:'2-4', items:[{name:'Инструменты отчётности',cost:50000},{name:'Консультация автоматизация',cost:100000}], total:150000 },
      { name:'Фаза 4: Стабилизация', months:'4-7', items:[{name:'IT-система',cost:500000},{name:'Регламенты',cost:150000}], total:650000 },
      { name:'Фаза 5: Команда', months:'7-12', items:[{name:'Найм руководителей (2)',cost:400000},{name:'Найм аналитика',cost:150000},{name:'Обучение',cost:300000}], total:850000 },
      { name:'Фаза 6: Family Office', months:'13-18', items:[{name:'Формирование блоков',cost:400000},{name:'Внешний аудит',cost:500000}], total:900000 }
    ],
    grandTotal:2550000
  },

  // ---------- RISKS ----------
  risks: [
    { title:'Сопротивление команды', level:'high', desc:'Сотрудники могут сопротивляться переходу от привычной модели «каждый за свой объект» к функциональному управлению.', mitigation:'Kotter step 1: создать срочность. Первые 30 дней — только прозрачность, без перестановок. Показать, что перегрузка снимается.' },
    { title:'Конфликт зон Никиты и Владимира', level:'high', desc:'При разделении на «доход» и «проекты» возможны споры о приоритетах бюджета и ресурсов.', mitigation:'Чёткая RACI-матрица. Споры решаются через цифры на еженедельном совещании. Эскалация → инвесткомитет.' },
    { title:'Потеря ключевых сотрудников', level:'medium', desc:'Татьяна, Екатерина, Иван — незаменимые. Уход любого из них критичен.', mitigation:'Документирование процессов с первого месяца. Мотивация: рост зоны ответственности + бонус за результат. Параллельная подготовка замен.' },
    { title:'Затягивание сроков строек', level:'medium', desc:'Капремонты и стройки могут затянуться, блокируя переход объектов в операционный блок.', mitigation:'Фиксация графиков в Фазе 1. Еженедельный контроль. Штрафы подрядчикам. Если стройка затягивается — объект остаётся у Владимира.' },
    { title:'Собственники вмешиваются в операционку', level:'medium', desc:'АН и ПВ могут продолжать принимать операционные решения, обходя управляющую команду.', mitigation:'Чёткое разграничение: собственники = стратегия + инвесткомитет. Операционка → Никита + Владимир. Формализация через Family Council.' },
    { title:'IT-система не подходит', level:'low', desc:'Выбранная система автоматизации может не покрыть специфику портфельного управления недвижимостью.', mitigation:'Пилот на 2-3 объектах перед полным внедрением. Тестирование 2 мес. Запасной вариант: собственная Excel/BI-модель.' },
    { title:'Не найти руководителей AM/Dev', level:'medium', desc:'Рынок узкий. Руководители с опытом управления портфелем 30 000+ м² — редкость.', mitigation:'Приоритет: выращивание Ивана (AM) и Алексея (Dev) из текущей команды. Параллельный поиск на рынке. Хедхантер с мес 6.' },
    { title:'Maison Rouge отвлекает ресурсы', level:'low', desc:'Ресторанный бизнес требует другой экспертизы и отвлекает управленческое внимание.', mitigation:'Выделить в отдельный P&L. Решение (развивать/продать/партнёр) — на инвесткомитете в Фазе 4.' }
  ],

  faq: [
    { q:'Зачем менять то, что работает?', a:'Система работает за счёт личного участия собственников и перегрузки ключевых людей. При росте портфеля с 7.5 до 12+ млрд текущая модель <strong>не масштабируется</strong>. Проблема не в людях — в архитектуре управления (Galbraith: структура не соответствует стратегии).' },
    { q:'Люди не разбегутся от изменений?', a:'Kotter: изменения начинаются не с людей, а с <strong>создания срочности и быстрых побед</strong>. Первые 30 дней — только прозрачность. Никто не теряет работу. Централизация = снятие дублирования и перегрузки, не сокращение.' },
    { q:'Как разделить зоны Никиты и Владимира без конфликтов?', a:'Ответственность по <strong>типу задач, не по объектам</strong>. Никита = доход (NOI, заполняемость). Владимир = создание активов (стройка, ввод). Зоны НЕ пересекаются. Споры → через цифры. Еженедельный управленческий совет.' },
    { q:'Что будет с объектами в ремонте?', a:'Объекты в ремонте → Владимир (Проекты). После ремонта → Никита (Операции). Чёткая точка передачи: <strong>Владимир строит → Никита зарабатывает</strong>.' },
    { q:'Зачем Family Council?', a:'Решает вопросы за рамками бизнеса: наследование, правила прибыли, стратегия на 10+ лет. Сейчас — 4 человека, ежеквартально. Фундамент для <strong>управления капиталом поколениями</strong>.' },
    { q:'Сколько стоит реструктуризация?', a:'~2.5 млн руб за 18 мес. Это <strong>0.03% от портфеля</strong> (7.5 млрд). Один неоптимальный объект в ремонте стоит в разы дороже.' },
    { q:'Как собственники будут контролировать?', a:'<strong>3 уровня:</strong> еженедельные отчёты команды; ежемесячный отчёт (доход, проекты, cash-flow); ежеквартальный инвесткомитет. Траст — независимый контрольный блок.' },
    { q:'Что если руководителей не найти?', a:'6 месяцев на формирование (мес 7-12). Приоритет — выращивание из команды (Иван, Алексей). Параллельно — рынок. Если не готовы к мес 12 — <strong>переходная структура продлевается</strong>.' },
    { q:'Почему 1-2% от прироста капитала?', a:'Фикс (400-600 тыс/мес) + бонус (3-6 млн/год) + <strong>1-2% от прироста капитализации</strong>. Рост с 7.5 до 10 млрд = бонус 25-50 млн на двоих. Собственники платят за рост, не за управление. Нет роста — нет бонуса.' },
    { q:'Maison Rouge — как вписывается?', a:'Ресторан — отдельный бизнес. В переходной структуре — доп.проект руководства. В целевой — отдельное управление со своим P&L. Решение (развивать/продать) — на инвесткомитете.' },
    { q:'Что если сроки затянутся?', a:'Переходная структура <strong>спроектирована как устойчивая</strong>. Если Фаза 5-6 затягивается — это ОК, переходная модель продолжает работать. Главное — не торопиться с наймом, а нанять правильных людей.' },
    { q:'Как оценить успех реструктуризации?', a:'<strong>5 KPI:</strong> 1) NOI портфеля +15% за 18 мес; 2) Заполняемость ≥92%; 3) Стройки в срок ±10%; 4) Еженедельная отчётность без пропусков; 5) Собственники тратят ≤4ч/нед на операционку.' }
  ]
};

// ============================================================
// NAVIGATION
// ============================================================
document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById('section-'+b.dataset.section).classList.add('active');
}));

// ============================================================
// JSON EXPORT/IMPORT
// ============================================================
function exportJSON(){
  const b=new Blob([JSON.stringify(STATE,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='restructuring-state.json';a.click();
}
function importJSON(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{try{Object.assign(STATE,JSON.parse(ev.target.result));renderAll(true);syncToFirebase();alert('Загружено!')}catch(err){alert('Ошибка: '+err.message)}};
  r.readAsText(f);
}

// ============================================================
// MODAL
// ============================================================
function openModal(html){document.getElementById('modal').innerHTML=html;document.getElementById('modal-overlay').classList.add('open')}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open')}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard(){
  const g=STATE.gantt;
  // Compute stats
  let totalTasks=0, completedTasks=0, totalProgress=0;
  const phaseStats=[];
  g.phases.forEach(ph=>{
    let pTasks=ph.tasks.length, pDone=0, pProg=0;
    ph.tasks.forEach(t=>{
      totalTasks++;
      const p=t.progress||0;
      totalProgress+=p;
      pProg+=p;
      if(p>=100)completedTasks++;
      if(p>=100)pDone++;
    });
    phaseStats.push({name:ph.name, tasks:pTasks, done:pDone, avg:pTasks?Math.round(pProg/pTasks):0, cls:ph.cls});
  });
  const avgProgress=totalTasks?Math.round(totalProgress/totalTasks):0;
  const totalBudget=STATE.budget.grandTotal;
  const totalObjects=STATE.delta.objects.length;
  const totalPeople=STATE.delta.people.length;

  let h='';
  // Top cards
  h+='<div class="dash-grid">';
  h+='<div class="dash-card"><div class="dc-value" style="color:var(--gold)">'+avgProgress+'%</div><div class="dc-label">Общий прогресс</div><div class="dc-sub">'+completedTasks+' из '+totalTasks+' задач</div></div>';
  h+='<div class="dash-card"><div class="dc-value" style="color:var(--green)">'+g.phases.length+'</div><div class="dc-label">Фаз</div><div class="dc-sub">'+g.months.length+' месяцев</div></div>';
  h+='<div class="dash-card"><div class="dc-value" style="color:var(--blue)">'+totalObjects+'</div><div class="dc-label">Объектов</div><div class="dc-sub">~31 000 м²</div></div>';
  h+='<div class="dash-card"><div class="dc-value" style="color:var(--purple)">'+(totalBudget/1e6).toFixed(1)+'М</div><div class="dc-label">Бюджет (руб)</div><div class="dc-sub">0.03% от портфеля</div></div>';
  h+='</div>';

  // Timeline
  h+='<div class="dash-timeline"><h3>Таймлайн ключевых вех</h3><div class="timeline-track"><div class="timeline-line"></div>';
  g.milestones.forEach(ms=>{
    const phaseIdx=g.phases.findIndex(p=>p.tasks.some(t=>t.s<=ms.month&&t.s+t.d>ms.month));
    const isDone=phaseStats[phaseIdx]?phaseStats[phaseIdx].avg>=100:false;
    const isCurrent=phaseStats[phaseIdx]?phaseStats[phaseIdx].avg>0&&phaseStats[phaseIdx].avg<100:false;
    h+='<div class="timeline-point"><div class="timeline-dot '+(isDone?'done':isCurrent?'active':'')+'"></div><div class="timeline-label">М'+(ms.month+1)+'<br><strong>'+ms.label+'</strong></div></div>';
  });
  h+='</div></div>';

  // Phase progress bars
  h+='<div class="dash-progress"><h3>Прогресс по фазам</h3>';
  const phaseColors=['var(--text3)','var(--green)','var(--blue)','var(--purple)','var(--orange)','var(--gold)','var(--cyan)'];
  phaseStats.forEach((ps,i)=>{
    h+='<div class="progress-row">';
    h+='<div class="pr-label">'+ps.name.split(':')[0]+' <span style="color:var(--text3)">('+ps.done+'/'+ps.tasks+')</span></div>';
    h+='<div class="pr-bar-bg"><div class="pr-bar" style="width:'+Math.max(ps.avg,2)+'%;background:'+(phaseColors[i]||'var(--gold)')+'">'+ps.avg+'%</div></div>';
    h+='<div class="pr-pct" style="color:'+(phaseColors[i]||'var(--gold)')+'">'+ps.avg+'%</div>';
    h+='</div>';
  });
  h+='</div>';

  document.getElementById('dashboard-content').innerHTML=h;
}

// ============================================================
// SVG TREE RENDERER
// ============================================================
function layoutTree(node, depth=0, x={val:0}) {
  if (!node.children || !node.children.length) {
    node._x = x.val; node._y = depth; node._w = 1;
    x.val += 1;
    return;
  }
  const startX = x.val;
  node.children.forEach(c => layoutTree(c, depth+1, x));
  const endX = x.val;
  node._w = endX - startX;
  node._x = startX + node._w/2 - 0.5;
  node._y = depth;
}

const treeZoom={};
function renderTree(containerId, treeData, treeName) {
  const tree = JSON.parse(JSON.stringify(treeData));
  layoutTree(tree);

  const nodeW=170, nodeH=64, gapX=186, gapY=110, padX=40, padY=40;
  function countLeaves(n){if(!n.children||!n.children.length)return 1;return n.children.reduce((s,c)=>s+countLeaves(c),0)}
  const leaves=countLeaves(tree);
  function maxDepth(n,d=0){if(!n.children||!n.children.length)return d;return Math.max(...n.children.map(c=>maxDepth(c,d+1)))}
  const depth=maxDepth(tree);
  const totalW=leaves*gapX+padX*2;
  const totalH=(depth+1)*gapY+padY*2;

  if(!treeZoom[containerId]) treeZoom[containerId]=1;
  const z=treeZoom[containerId];
  const container=document.getElementById(containerId);
  container.style.height=Math.max(totalH*z+20,400)+'px';

  let svgPaths='';
  let nodesHtml='';

  function px(node){return padX+node._x*gapX+(gapX-nodeW)/2}
  function py(node){return padY+node._y*gapY}

  function walk(node){
    const x1=px(node)+nodeW/2, y1=py(node)+nodeH;
    if(node.children){
      node.children.forEach(c=>{
        const x2=px(c)+nodeW/2, y2=py(c);
        const my=(y1+y2)/2;
        svgPaths+=`<path d="M${x1},${y1} C${x1},${my} ${x2},${my} ${x2},${y2}"/>`;
        walk(c);
      });
    }
    const cls=node.color||'';
    let badge='';
    if(node.badge) badge=`<span class="tn-badge ${node.badgeCls||''}">${node.badge}</span>`;
    nodesHtml+=`<div class="tn ${cls}" style="left:${px(node)}px;top:${py(node)}px;width:${nodeW}px" onclick="editTreeNode('${treeName}','${node.id}')" title="Клик для редактирования">${badge}<div class="tn-title">${node.label}</div>${node.sub?'<div class="tn-sub">'+node.sub+'</div>':''}${node.people?'<div class="tn-people">'+node.people+'</div>':''}</div>`;
  }
  walk(tree);

  container.innerHTML=`<div class="tree-controls"><button onclick="zoomTree('${containerId}','${treeName}',0.1)" title="Увеличить">+</button><button onclick="zoomTree('${containerId}','${treeName}',-0.1)" title="Уменьшить">&minus;</button><button onclick="treeZoom['${containerId}']=1;renderTree('${containerId}',STATE.trees.${treeName},'${treeName}')" title="Сбросить">1:1</button><button onclick="exportTreeSVG('${containerId}','${treeName}')" title="Скачать SVG">&#8615;</button></div><div class="tree-scroll"><div class="tree-inner" style="transform:scale(${z});width:${totalW}px;height:${totalH}px"><svg class="tree-svg" width="${totalW}" height="${totalH}">${svgPaths}</svg><div class="tree-nodes" style="width:${totalW}px;height:${totalH}px">${nodesHtml}</div></div></div>`;
  container.querySelector('.tree-scroll').scrollLeft=(totalW*z-container.clientWidth)/2;

  // Pinch-to-zoom on trackpad
  const scrollEl=container.querySelector('.tree-scroll');
  scrollEl.addEventListener('wheel',function(e){
    if(e.ctrlKey||e.metaKey){
      e.preventDefault();
      const delta=e.deltaY>0?-0.05:0.05;
      treeZoom[containerId]=Math.max(0.4,Math.min(1.5,(treeZoom[containerId]||1)+delta));
      renderTree(containerId,STATE.trees[treeName],treeName);
    }
  },{passive:false});
}

function zoomTree(cid,tname,delta){
  treeZoom[cid]=Math.max(0.4,Math.min(1.5,(treeZoom[cid]||1)+delta));
  renderTree(cid,STATE.trees[tname],tname);
}

function exportTreeSVG(containerId,treeName){
  const container=document.getElementById(containerId);
  const inner=container.querySelector('.tree-inner');
  const svgEl=container.querySelector('.tree-svg');
  const nodes=container.querySelectorAll('.tn');
  const w=parseInt(svgEl.getAttribute('width')), h=parseInt(svgEl.getAttribute('height'));

  // Build standalone SVG with embedded nodes
  let svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="background:#0D0B0E">`;
  svg+=`<style>.path{fill:none;stroke:#2A2433;stroke-width:2.5;stroke-linecap:round}.box{rx:10;fill:#1A1620;stroke:#2A2433;stroke-width:1.5}.title{font:bold 13px system-ui;fill:#E8E0F0;text-anchor:middle}.sub{font:11px system-ui;fill:#A898B8;text-anchor:middle}.people{font:10px system-ui;fill:#6B6573;text-anchor:middle}</style>`;
  // Copy paths
  svgEl.querySelectorAll('path').forEach(p=>{ svg+=`<path class="path" d="${p.getAttribute('d')}"/>`; });
  // Convert HTML nodes to SVG rects+text
  nodes.forEach(n=>{
    const left=parseInt(n.style.left), top=parseInt(n.style.top), nw=parseInt(n.style.width)||170;
    svg+=`<rect class="box" x="${left}" y="${top}" width="${nw}" height="64"/>`;
    const titleEl=n.querySelector('.tn-title');
    if(titleEl) svg+=`<text class="title" x="${left+nw/2}" y="${top+28}">${titleEl.textContent}</text>`;
    const subEl=n.querySelector('.tn-sub');
    if(subEl) svg+=`<text class="sub" x="${left+nw/2}" y="${top+44}">${subEl.textContent}</text>`;
    const pplEl=n.querySelector('.tn-people');
    if(pplEl) svg+=`<text class="people" x="${left+nw/2}" y="${top+58}">${pplEl.textContent}</text>`;
  });
  svg+=`</svg>`;
  const blob=new Blob([svg],{type:'image/svg+xml'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=treeName+'-structure.svg';a.click();
}

function findNode(tree,id){
  if(tree.id===id)return tree;
  if(tree.children)for(const c of tree.children){const r=findNode(c,id);if(r)return r}
  return null;
}
function findParent(tree,id){
  if(tree.children)for(const c of tree.children){if(c.id===id)return tree;const r=findParent(c,id);if(r)return r}
  return null;
}

function editTreeNode(treeName,nodeId){
  const tree=STATE.trees[treeName];
  const node=findNode(tree,nodeId);
  if(!node)return;
  const parent=findParent(tree,nodeId);
  const colors=[{cls:'',label:'Серый (по умолчанию)'},{cls:'tn-gold',label:'Золотой (собственники)'},{cls:'tn-red',label:'Красный (контроль)'},{cls:'tn-green',label:'Зелёный (Никита)'},{cls:'tn-blue',label:'Синий (Владимир)'},{cls:'tn-purple',label:'Фиолетовый (совместные)'}];
  let colorOpts='';
  colors.forEach(c=>{colorOpts+=`<option value="${c.cls}" ${(node.color||'')===c.cls?'selected':''}>${c.label}</option>`});
  openModal(`<h3>Редактировать узел</h3>
    <label>Название</label><input id="tn-label" value="${node.label||''}">
    <label>Подпись (роль/функция)</label><input id="tn-sub" value="${node.sub||''}">
    <label>Люди</label><input id="tn-people" value="${node.people||''}" placeholder="Иван, Екатерина">
    <label>Цвет</label><select id="tn-color">${colorOpts}</select>
    <label>Бейдж</label><input id="tn-badge" value="${node.badge||''}" placeholder="Доход / Ремонт / Стройка">
    <div class="modal-actions">
      ${parent?'<button class="btn btn-danger" onclick="deleteTreeNode(\''+treeName+'\',\''+nodeId+'\')">Удалить</button>':''}
      <button class="btn btn-secondary" onclick="addTreeChild('${treeName}','${nodeId}')">+ Дочерний</button>
      <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
      <button class="btn btn-primary" onclick="saveTreeNode('${treeName}','${nodeId}')">Сохранить</button>
    </div>`);
}

function saveTreeNode(treeName,nodeId){
  const node=findNode(STATE.trees[treeName],nodeId);
  node.label=document.getElementById('tn-label').value;
  node.sub=document.getElementById('tn-sub').value;
  node.people=document.getElementById('tn-people').value||undefined;
  node.color=document.getElementById('tn-color').value||'';
  const b=document.getElementById('tn-badge').value;
  node.badge=b||undefined;
  if(b){
    if(b.toLowerCase().includes('доход'))node.badgeCls='badge-income';
    else if(b.toLowerCase().includes('ремонт'))node.badgeCls='badge-renovation';
    else if(b.toLowerCase().includes('строй'))node.badgeCls='badge-construction';
    else node.badgeCls='';
  }
  closeModal();
  renderTree('tree-'+treeName,STATE.trees[treeName],treeName);
  syncToFirebase();
}

function deleteTreeNode(treeName,nodeId){
  const tree=STATE.trees[treeName];
  const parent=findParent(tree,nodeId);
  if(parent&&parent.children){parent.children=parent.children.filter(c=>c.id!==nodeId)}
  closeModal();
  renderTree('tree-'+treeName,STATE.trees[treeName],treeName);
  syncToFirebase();
}

function addTreeChild(treeName,parentId){
  const node=findNode(STATE.trees[treeName],parentId);
  if(!node.children)node.children=[];
  const newId=treeName+'_new_'+Date.now();
  node.children.push({id:newId,label:'Новый узел',sub:'',color:node.color||''});
  closeModal();
  renderTree('tree-'+treeName,STATE.trees[treeName],treeName);
  syncToFirebase();
}

// ============================================================
// GANTT RENDERER v3 — deps + progress + milestones
// ============================================================
let ganttDrag=null;

function renderGantt(){
  const g=STATE.gantt;
  const M=g.months.length;
  const labelW=320;
  let html='<div class="gantt-wrap"><div class="gantt-toolbar">';
  html+='<button onclick="addGanttPhase()">+ Фаза</button>';
  html+='<button onclick="addGanttColumn()">+ Столбец</button>';
  html+='<button onclick="removeGanttColumn()">− Столбец</button>';
  html+='<span style="font-size:11px;color:var(--text3);margin-left:8px">Двойной клик на фазу = редактировать</span>';
  html+='</div><div class="gantt-scroll" id="gantt-scroll"><div class="gantt-grid" id="gantt-grid" style="grid-template-columns:'+labelW+'px repeat('+M+',1fr)">';

  // header with milestones — click to rename months
  html+='<div class="gantt-corner">Задача / Ответственный</div>';
  g.months.forEach((m,mi)=>{
    const isMilestone=g.milestones.some(ms=>ms.month===mi);
    const msLabel=g.milestones.find(ms=>ms.month===mi);
    html+='<div class="gantt-mh editable'+(isMilestone?' milestone':'')+'" title="Клик — переименовать" ondblclick="editGanttMonth('+mi+')">'+m+(msLabel?'<br><span style="color:var(--gold);font-size:8px">'+msLabel.label+'</span>':'')+'</div>';
  });


  // phases + tasks
  g.phases.forEach((phase,pi)=>{
    const phaseTotal=phase.tasks.length;
    const phaseAvg=phaseTotal?Math.round(phase.tasks.reduce((s,t)=>s+(t.progress||0),0)/phaseTotal):0;
    const phaseDone=phase.tasks.filter(t=>(t.progress||0)>=100).length;
    const phColor=phaseAvg>=100?'var(--green)':phaseAvg>0?'var(--gold)':'var(--text3)';
    html+='<div class="gantt-label phase-row" style="cursor:pointer;justify-content:space-between" ondblclick="editGanttPhase('+pi+')">';
    html+='<span style="flex:1;display:flex;align-items:center;gap:8px">'+phase.name;
    html+='<span style="font-size:10px;color:'+phColor+';white-space:nowrap" title="'+phaseDone+' из '+phaseTotal+' задач завершено">'+phaseAvg+'% ('+phaseDone+'/'+phaseTotal+')</span></span>';
    html+='<span style="display:flex;gap:2px;align-items:center">';
    if(pi>0) html+='<button class="gantt-move-btn" title="Фазу вверх" onclick="event.stopPropagation();moveGanttPhase('+pi+',-1)">&#9650;</button>';
    if(pi<g.phases.length-1) html+='<button class="gantt-move-btn" title="Фазу вниз" onclick="event.stopPropagation();moveGanttPhase('+pi+',1)">&#9660;</button>';
    html+='</span></div>';
    // phase progress bar across columns
    const phBarW=phaseAvg+'%';
    for(let i=0;i<M;i++){
      if(i===0) html+='<div class="gantt-cell phase-row" style="position:relative;overflow:visible" colspan="'+M+'"><div style="position:absolute;top:0;left:0;height:100%;width:'+phBarW+';background:'+phColor+';opacity:0.1;border-radius:4px;pointer-events:none"></div></div>';
      else html+='<div class="gantt-cell phase-row"></div>';
    }

    phase.tasks.forEach((task,ti)=>{
      const prog=task.progress||0;
      const progColor=prog>=100?'var(--green)':prog>0?'var(--gold)':'var(--text3)';

      html+='<div class="gantt-label"><span class="gl-progress" style="color:'+progColor+'">'+prog+'%</span>';
      html+='<span style="display:flex;flex-direction:column;gap:0;margin-right:2px">';
      if(ti>0) html+='<button class="gantt-move-btn" title="Вверх" onclick="moveGanttTask('+pi+','+ti+',-1)">&#9650;</button>';
      if(ti<phase.tasks.length-1) html+='<button class="gantt-move-btn" title="Вниз" onclick="moveGanttTask('+pi+','+ti+',1)">&#9660;</button>';
      html+='</span>';
      html+='<span class="gl-name" title="Двойной клик — редактировать" ondblclick="editGanttTask('+pi+','+ti+')">'+task.name+'</span><span class="gl-owner">'+task.owner+'</span>';
      html+='<button class="gantt-add-btn" title="Добавить задачу после" onclick="addGanttTask('+pi+','+ti+')">+</button></div>';

      for(let i=0;i<M;i++){
        html+='<div class="gantt-cell" data-pi="'+pi+'" data-ti="'+ti+'" data-col="'+i+'">';
        if(i>=task.s && i<task.s+task.d){
          const isFirst=i===task.s;
          const isLast=i===task.s+task.d-1;
          let barStyle='';
          if(isFirst&&isLast) barStyle='left:4px;right:4px;border-radius:4px';
          else if(isFirst) barStyle='left:4px;right:0;border-radius:4px 0 0 4px';
          else if(isLast) barStyle='left:0;right:4px;border-radius:0 4px 4px 0';
          else barStyle='left:0;right:0;border-radius:0';
          html+='<div class="g-bar '+phase.cls+'" style="'+barStyle+'" data-pi="'+pi+'" data-ti="'+ti+'" ondblclick="editGanttTask('+pi+','+ti+')" onmousedown="startGanttDrag(event,'+pi+','+ti+')">';
          if(isFirst && prog>0){
            html+='<div class="g-progress-fill" style="width:'+Math.min(prog,100)+'%"></div>';
          }
          if(isLast) html+='<div class="g-resize" onmousedown="startGanttResize(event,'+pi+','+ti+')"></div>';
          html+='</div>';
        }
        html+='</div>';
      }
      });
  });

  html+='</div>';

  html+='</div></div>';

  // Summary stats
  let totalTasks=0,doneTasks=0;
  g.phases.forEach(ph=>ph.tasks.forEach(t=>{totalTasks++;if((t.progress||0)>=100)doneTasks++}));
  html+='<div style="margin-top:12px;display:flex;gap:20px;font-size:12px;color:var(--text2)">';
  html+='<span>Всего задач: <strong style="color:var(--text)">'+totalTasks+'</strong></span>';
  html+='<span>Выполнено: <strong style="color:var(--green)">'+doneTasks+'</strong></span>';
  html+='<span>В работе: <strong style="color:var(--gold)">'+(totalTasks-doneTasks)+'</strong></span>';
  html+='</div>';

  document.getElementById('gantt-content').innerHTML=html;

}

function startGanttDrag(e,pi,ti){
  if(e.target.classList.contains('g-resize'))return;
  e.preventDefault();
  const task=STATE.gantt.phases[pi].tasks[ti];
  const cells=document.querySelectorAll('.gantt-cell[data-pi="'+pi+'"][data-ti="'+ti+'"]');
  if(!cells.length)return;
  const cellW=cells[0].offsetWidth;
  const startX=e.clientX;
  const origS=task.s;

  function onMove(ev){
    const dx=ev.clientX-startX;
    const dc=Math.round(dx/cellW);
    task.s=Math.max(0,Math.min(STATE.gantt.months.length-task.d, origS+dc));
    renderGantt();
  }
  function onUp(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);syncToFirebase()}
  document.addEventListener('mousemove',onMove);
  document.addEventListener('mouseup',onUp);
}

function startGanttResize(e,pi,ti){
  e.preventDefault();e.stopPropagation();
  const task=STATE.gantt.phases[pi].tasks[ti];
  const cells=document.querySelectorAll('.gantt-cell[data-pi="'+pi+'"][data-ti="'+ti+'"]');
  if(!cells.length)return;
  const cellW=cells[0].offsetWidth;
  const startX=e.clientX;
  const origD=task.d;

  function onMove(ev){
    const dx=ev.clientX-startX;
    const dc=Math.round(dx/cellW);
    task.d=Math.max(1,Math.min(STATE.gantt.months.length-task.s, origD+dc));
    renderGantt();
  }
  function onUp(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);syncToFirebase()}
  document.addEventListener('mousemove',onMove);
  document.addEventListener('mouseup',onUp);
}

function editGanttTask(pi,ti){
  const task=STATE.gantt.phases[pi].tasks[ti];
  // Build deps checkboxes
  let depsHtml='<div style="max-height:120px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;padding:8px;margin-top:4px">';
  STATE.gantt.phases.forEach((ph,ppi)=>{
    ph.tasks.forEach((t,tti)=>{
      if(ppi===pi&&tti===ti)return;
      const isChecked=task.deps&&task.deps.some(d=>d[0]===ppi&&d[1]===tti);
      const shortName=ph.name.split(':')[0]+' → '+t.name.substring(0,25);
      depsHtml+='<label style="display:block;font-size:11px;padding:2px 0;cursor:pointer"><input type="checkbox" class="dep-cb" data-pi="'+ppi+'" data-ti="'+tti+'" '+(isChecked?'checked':'')+' style="margin-right:4px">'+shortName+'</label>';
    });
  });
  depsHtml+='</div>';

  openModal(`<h3>Редактировать задачу</h3>
    <label>Название</label><input id="gt-name" value="${task.name}">
    <label>Ответственный</label><input id="gt-owner" value="${task.owner}">
    <label>Начало (месяц, 0-based)</label><input id="gt-s" type="number" min="0" max="${STATE.gantt.months.length-1}" value="${task.s}">
    <label>Длительность (месяцев)</label><input id="gt-d" type="number" min="1" max="${STATE.gantt.months.length}" value="${task.d}">
    <label>Прогресс (%)</label><input id="gt-p" type="range" min="0" max="100" step="5" value="${task.progress||0}" oninput="document.getElementById('gt-pv').textContent=this.value+'%'" style="width:100%"><span id="gt-pv" style="font-size:12px;color:var(--gold)">${task.progress||0}%</span>
    <label>Зависимости (после каких задач)</label>${depsHtml}
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="deleteGanttTask(${pi},${ti})">Удалить</button>
      <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
      <button class="btn btn-primary" onclick="saveGanttTask(${pi},${ti})">Сохранить</button>
    </div>`);
}

function saveGanttTask(pi,ti){
  const t=STATE.gantt.phases[pi].tasks[ti];
  t.name=document.getElementById('gt-name').value;
  t.owner=document.getElementById('gt-owner').value;
  t.s=parseInt(document.getElementById('gt-s').value)||0;
  t.d=parseInt(document.getElementById('gt-d').value)||1;
  t.progress=parseInt(document.getElementById('gt-p').value)||0;

  // Collect deps
  const deps=[];
  document.querySelectorAll('.dep-cb:checked').forEach(cb=>{
    deps.push([parseInt(cb.dataset.pi),parseInt(cb.dataset.ti)]);
  });
  t.deps=deps;

  closeModal();renderGantt();renderDashboard();syncToFirebase();
}

function deleteGanttTask(pi,ti){
  STATE.gantt.phases[pi].tasks.splice(ti,1);
  closeModal();renderGantt();renderDashboard();syncToFirebase();
}

function addGanttTask(pi,afterTi){
  const phase=STATE.gantt.phases[pi];
  const prev=phase.tasks[afterTi];
  phase.tasks.splice(afterTi+1,0,{name:'Новая задача',owner:'TBD',s:prev?prev.s+prev.d:0,d:1,progress:0,deps:[]});
  renderGantt();syncToFirebase();
}

function moveGanttTask(pi,ti,dir){
  const tasks=STATE.gantt.phases[pi].tasks;
  const newTi=ti+dir;
  if(newTi<0||newTi>=tasks.length)return;
  const tmp=tasks[ti];
  tasks[ti]=tasks[newTi];
  tasks[newTi]=tmp;
  renderGantt();syncToFirebase();
}

function editGanttMonth(mi){
  const current=STATE.gantt.months[mi];
  const newName=prompt('Название столбца (месяц '+mi+'):',current);
  if(newName!==null&&newName!==current){
    STATE.gantt.months[mi]=newName;
    renderGantt();syncToFirebase();
  }
}

function editGanttPhase(pi){
  const phase=STATE.gantt.phases[pi];
  const newName=prompt('Название фазы:',phase.name);
  if(newName===null)return;
  if(newName===''){
    if(confirm('Удалить фазу «'+phase.name+'» и все её задачи?')){
      STATE.gantt.phases.splice(pi,1);
      renderGantt();syncToFirebase();
    }
    return;
  }
  if(newName!==phase.name){ phase.name=newName; renderGantt();syncToFirebase(); }
}

function moveGanttPhase(pi,dir){
  const phases=STATE.gantt.phases;
  const newPi=pi+dir;
  if(newPi<0||newPi>=phases.length)return;
  const tmp=phases[pi]; phases[pi]=phases[newPi]; phases[newPi]=tmp;
  renderGantt();syncToFirebase();
}

function addGanttPhase(){
  const name=prompt('Название новой фазы:','Фаза '+ STATE.gantt.phases.length);
  if(!name)return;
  const clsIdx=STATE.gantt.phases.length % 7;
  STATE.gantt.phases.push({ name:name, cls:'p'+clsIdx, tasks:[
    { name:'Новая задача', owner:'—', s:0, d:1, progress:0, deps:[] }
  ]});
  renderGantt();syncToFirebase();
}

function addGanttColumn(){
  const nextNum=STATE.gantt.months.length+1;
  const name=prompt('Название нового столбца:','Мес '+nextNum);
  if(!name)return;
  STATE.gantt.months.push(name);
  renderGantt();syncToFirebase();
}

function removeGanttColumn(){
  if(STATE.gantt.months.length<=1){ alert('Нельзя удалить последний столбец'); return; }
  const last=STATE.gantt.months[STATE.gantt.months.length-1];
  if(!confirm('Удалить столбец «'+last+'»?'))return;
  STATE.gantt.months.pop();
  // trim tasks that extend beyond
  const maxM=STATE.gantt.months.length;
  STATE.gantt.phases.forEach(ph=>ph.tasks.forEach(t=>{
    if(t.s>=maxM) t.s=maxM-1;
    if(t.s+t.d>maxM) t.d=maxM-t.s;
  }));
  renderGantt();syncToFirebase();
}

// ============================================================
// DELTA, RACI, BUDGET, RISKS, FAQ, FRAMEWORKS renderers
// ============================================================
function renderDelta(){
  const d=STATE.delta;
  let h='<h3 style="margin-bottom:12px">Переход по сотрудникам</h3>';
  h+='<table class="data-table"><thead><tr><th>Сотрудник</th><th>AS-IS</th><th>Переходная (12 мес)</th><th>Целевая (18+ мес)</th></tr></thead><tbody>';
  d.people.forEach((p,i)=>{
    h+='<tr><td style="font-weight:600">'+p.name+'</td>';
    ['asIs','transition','target'].forEach(k=>{
      h+='<td contenteditable="true" onblur="STATE.delta.people['+i+'].'+k+'=this.textContent;syncToFirebase()">'+p[k]+'</td>';
    });
    h+='</tr>';
  });
  h+='</tbody></table><h3 style="margin:24px 0 12px">Переход по объектам</h3>';
  h+='<table class="data-table"><thead><tr><th>Объект</th><th>AS-IS</th><th>Переходная</th><th>Целевая</th></tr></thead><tbody>';
  d.objects.forEach((o,i)=>{
    h+='<tr><td style="font-weight:600">'+o.name+'</td>';
    ['asIs','transition','target'].forEach(k=>{
      h+='<td contenteditable="true" onblur="STATE.delta.objects['+i+'].'+k+'=this.textContent;syncToFirebase()">'+o[k]+'</td>';
    });
    h+='</tr>';
  });
  h+='</tbody></table>';
  document.getElementById('delta-content').innerHTML=h;
}

let raciFilter='';
let raciShowOverlap=false;
function renderRaci(){
  const r=STATE.raci;

  // Compute overlaps: roles with R in 3+ processes = overloaded
  const overloadMap={}; // ri -> count of R
  const overloadRows=new Set(); // process indices where overloaded role has R
  r.roles.forEach((role,ri)=>{
    const rCount=r.processes.filter(p=>p.v[ri]==='R').length;
    overloadMap[ri]=rCount;
    if(raciShowOverlap && rCount>=3){
      r.processes.forEach((p,pi)=>{ if(p.v[ri]==='R') overloadRows.add(pi); });
    }
  });

  // Action toolbar
  let h='<div style="margin-bottom:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
  h+='<button style="padding:4px 10px;border-radius:6px;border:1px solid var(--green);background:var(--card);color:var(--green);cursor:pointer;font-size:12px" onclick="addRaciProcess()">+ Процесс</button>';
  h+='<button style="padding:4px 10px;border-radius:6px;border:1px solid var(--blue);background:var(--card);color:var(--blue);cursor:pointer;font-size:12px" onclick="addRaciRole()">+ Роль</button>';
  const ovBorder=raciShowOverlap?'var(--red)':'var(--border)';
  const ovColor=raciShowOverlap?'var(--red)':'var(--text2)';
  h+='<button style="padding:4px 10px;border-radius:6px;border:1px solid '+ovBorder+';background:var(--card);color:'+ovColor+';cursor:pointer;font-size:12px" onclick="raciShowOverlap=!raciShowOverlap;renderRaci()">Пересечения</button>';
  h+='<span style="margin-left:8px;font-size:11px;color:var(--text3)">Двойной клик на название = редактировать</span>';
  h+='</div>';
  // Filter toolbar
  h+='<div style="margin-bottom:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
  h+='<span style="font-size:12px;color:var(--text2)">Фильтр:</span>';
  h+='<button style="padding:4px 10px;border-radius:6px;border:1px solid '+(raciFilter===''?'var(--gold)':'var(--border)')+';background:'+(raciFilter===''?'var(--card2)':'var(--card)')+';color:'+(raciFilter===''?'var(--gold)':'var(--text2)')+';cursor:pointer;font-size:12px" onclick="raciFilter=\'\';renderRaci()">Все</button>';
  r.roles.forEach((role,ri)=>{
    const active=raciFilter===role;
    h+='<button style="padding:4px 10px;border-radius:6px;border:1px solid '+(active?'var(--gold)':'var(--border)')+';background:'+(active?'var(--card2)':'var(--card)')+';color:'+(active?'var(--gold)':'var(--text2)')+';cursor:pointer;font-size:12px" onclick="raciFilter=\''+role+'\';renderRaci()">'+role+'</button>';
  });
  h+='</div>';

  h+='<div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Процесс</th>';
  r.roles.forEach((role,ri)=>{
    const isOverloaded=raciShowOverlap&&overloadMap[ri]>=3;
    h+='<th style="text-align:center;cursor:pointer'+(isOverloaded?';color:var(--red);background:rgba(212,64,64,0.1)':'')+'" ondblclick="editRaciRole('+ri+')" title="'+(isOverloaded?'Перегрузка: R в '+overloadMap[ri]+' процессах!':'Двойной клик — редактировать')+'">'+role+(isOverloaded?' <span style="font-size:9px">'+overloadMap[ri]+'R</span>':'')+'</th>';
  });
  h+='</tr></thead><tbody>';
  r.processes.forEach((p,pi)=>{
    if(raciFilter){
      const ri=r.roles.indexOf(raciFilter);
      if(ri===-1||!(p.v[ri]==='R'||p.v[ri]==='A')){
        // also check subs
        const hasSub=p.subs&&p.subs.some(s=>s.v[ri]==='R'||s.v[ri]==='A');
        if(!hasSub)return;
      }
    }
    const isHighlighted=raciShowOverlap&&overloadRows.has(pi);
    const hasSubs=p.subs&&p.subs.length>0;
    const isExpanded=p._expanded;
    h+='<tr style="'+(isHighlighted?'background:rgba(212,64,64,0.08)':'')+'"><td style="font-weight:600;cursor:pointer;position:relative" ondblclick="editRaciProcess('+pi+')">';
    if(hasSubs||true) h+='<span style="display:inline-block;width:16px;cursor:pointer;color:var(--text3);font-size:10px" onclick="event.stopPropagation();toggleRaciSubs('+pi+')">'+(isExpanded?'&#9660;':'&#9654;')+'</span>';
    h+='<span>'+p.name+'</span>';
    h+='<button style="position:absolute;right:24px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--green);cursor:pointer;font-size:14px;opacity:0.5" onclick="event.stopPropagation();addRaciSub('+pi+')" title="+ подпроцесс">+</button>';
    h+='<button style="position:absolute;right:4px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;opacity:0.4" onclick="deleteRaciProcess('+pi+')" title="Удалить">&times;</button>';
    h+='</td>';
    p.v.forEach((val,vi)=>{
      const cellOverload=raciShowOverlap&&val==='R'&&overloadMap[vi]>=3;
      h+='<td class="raci-cell raci-'+val+'" style="'+(cellOverload?'box-shadow:inset 0 0 0 2px var(--red)':'')+'" onclick="STATE.raci.processes['+pi+'].v['+vi+']=\'RACI\'[\'RACI\'.indexOf(STATE.raci.processes['+pi+'].v['+vi+'])+1&3];renderRaci();syncToFirebase()">'+val+'</td>';
    });
    h+='</tr>';
    // Sub-processes
    if(isExpanded&&p.subs){
      p.subs.forEach((sub,si)=>{
        h+='<tr style="background:var(--bg)"><td style="padding-left:32px;font-size:11px;color:var(--text2);cursor:pointer;position:relative" ondblclick="editRaciSub('+pi+','+si+')">';
        h+='&#8627; '+sub.name;
        h+='<button style="position:absolute;right:4px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--red);cursor:pointer;font-size:12px;opacity:0.4" onclick="deleteRaciSub('+pi+','+si+')" title="Удалить">&times;</button>';
        h+='</td>';
        sub.v.forEach((val,vi)=>{
          h+='<td class="raci-cell raci-'+val+'" style="opacity:0.8" onclick="STATE.raci.processes['+pi+'].subs['+si+'].v['+vi+']=\'RACI\'[\'RACI\'.indexOf(STATE.raci.processes['+pi+'].subs['+si+'].v['+vi+'])+1&3];renderRaci();syncToFirebase()">'+val+'</td>';
        });
        h+='</tr>';
      });
    }
  });
  h+='</tbody></table></div>';
  h+='<div style="margin-top:12px;font-size:12px;color:var(--text2)"><strong style="color:var(--green)">R</strong> выполняет &nbsp;<strong style="color:var(--gold)">A</strong> решает &nbsp;<strong style="color:var(--blue)">C</strong> согласовывает &nbsp;<strong style="color:var(--text3)">I</strong> информируется</div>';

  if(raciFilter){
    const ri=r.roles.indexOf(raciFilter);
    const rCount=r.processes.filter(p=>p.v[ri]==='R').length;
    const aCount=r.processes.filter(p=>p.v[ri]==='A').length;
    h+='<div style="margin-top:8px;font-size:12px;color:var(--gold)">'+raciFilter+': <strong>'+rCount+'</strong> задач выполняет (R), <strong>'+aCount+'</strong> решает (A)</div>';
  }
  if(raciShowOverlap){
    h+='<div style="margin-top:12px;padding:10px;background:rgba(212,64,64,0.08);border:1px solid var(--red);border-radius:8px;font-size:12px">';
    h+='<strong style="color:var(--red)">Анализ пересечений:</strong><br>';
    r.roles.forEach((role,ri)=>{
      if(overloadMap[ri]>=3) h+='<span style="color:var(--red)">'+role+'</span> — R в '+overloadMap[ri]+' процессах (перегрузка)<br>';
    });
    const noOverlap=!r.roles.some((role,ri)=>overloadMap[ri]>=3);
    if(noOverlap) h+='<span style="color:var(--green)">Перегрузок не обнаружено (порог: 3+ процессов с R у одного лица)</span>';
    h+='</div>';
  }

  document.getElementById('raci-content').innerHTML=h;
}
function editRaciProcess(pi){
  const name=prompt('Название процесса:',STATE.raci.processes[pi].name);
  if(name!==null&&name!==''){ STATE.raci.processes[pi].name=name; renderRaci();syncToFirebase(); }
}
function deleteRaciProcess(pi){
  if(!confirm('Удалить «'+STATE.raci.processes[pi].name+'»?'))return;
  STATE.raci.processes.splice(pi,1); renderRaci();syncToFirebase();
}
function addRaciProcess(){
  const name=prompt('Название нового процесса:');
  if(!name)return;
  STATE.raci.processes.push({name:name, v:STATE.raci.roles.map(()=>'I')});
  renderRaci();syncToFirebase();
}
function editRaciRole(ri){
  const name=prompt('Название роли:',STATE.raci.roles[ri]);
  if(name!==null&&name!==''){ STATE.raci.roles[ri]=name; renderRaci();syncToFirebase(); }
}
function addRaciRole(){
  const name=prompt('Название новой роли:');
  if(!name)return;
  STATE.raci.roles.push(name);
  STATE.raci.processes.forEach(p=>{
    p.v.push('I');
    if(p.subs) p.subs.forEach(s=>s.v.push('I'));
  });
  renderRaci();syncToFirebase();
}
function toggleRaciSubs(pi){
  STATE.raci.processes[pi]._expanded=!STATE.raci.processes[pi]._expanded;
  renderRaci();
}
function addRaciSub(pi){
  const name=prompt('Название подпроцесса:');
  if(!name)return;
  if(!STATE.raci.processes[pi].subs) STATE.raci.processes[pi].subs=[];
  STATE.raci.processes[pi].subs.push({name:name, v:STATE.raci.roles.map(()=>'I')});
  STATE.raci.processes[pi]._expanded=true;
  renderRaci();syncToFirebase();
}
function editRaciSub(pi,si){
  const name=prompt('Название подпроцесса:',STATE.raci.processes[pi].subs[si].name);
  if(name!==null&&name!==''){ STATE.raci.processes[pi].subs[si].name=name; renderRaci();syncToFirebase(); }
}
function deleteRaciSub(pi,si){
  if(!confirm('Удалить подпроцесс?'))return;
  STATE.raci.processes[pi].subs.splice(si,1);
  renderRaci();syncToFirebase();
}

function renderBpmn(){
  const r=STATE.raci;
  const processes=r.processes;
  const nodeW=160, nodeH=70, gapX=200, gapY=100, padX=60, padY=60;

  // Group processes into swim lanes by primary responsible (R)
  const lanes={};
  processes.forEach((p,pi)=>{
    let owner='Не назначен';
    p.v.forEach((val,vi)=>{ if(val==='R') owner=r.roles[vi]; });
    if(!lanes[owner]) lanes[owner]=[];
    lanes[owner].push({name:p.name, pi:pi, owner:owner});
  });
  const laneNames=Object.keys(lanes);

  // Compute canvas size
  const maxPerLane=Math.max(...laneNames.map(l=>lanes[l].length));
  const totalW=padX*2+maxPerLane*gapX+60;
  const laneH=nodeH+gapY;
  const totalH=padY*2+laneNames.length*laneH+40;

  let h='<div class="bpmn-canvas" style="height:'+Math.max(totalH,400)+'px">';
  // SVG for arrows
  h+='<svg style="position:absolute;top:0;left:0;width:'+totalW+'px;height:'+totalH+'px;pointer-events:none">';

  // Draw swim lane backgrounds and labels
  laneNames.forEach((lane,li)=>{
    const y=padY+li*laneH;
    h+='<rect x="0" y="'+y+'" width="'+totalW+'" height="'+laneH+'" fill="'+(li%2===0?'rgba(255,255,255,0.02)':'rgba(255,255,255,0.01)')+'" stroke="rgba(255,255,255,0.05)"/>';
    h+='<text x="12" y="'+(y+laneH/2+4)+'" fill="'+(lane==='Не назначен'?'#6B6573':'#C9A44C')+'" font-size="11" font-weight="700" font-family="system-ui">'+lane+'</text>';
  });

  // Draw nodes and arrows
  let prevX=0, prevY=0, first=true;
  const nodePositions=[];
  laneNames.forEach((lane,li)=>{
    lanes[lane].forEach((proc,ni)=>{
      const x=padX+60+ni*gapX;
      const y=padY+li*laneH+(laneH-nodeH)/2;
      nodePositions.push({x:x,y:y,pi:proc.pi});
    });
  });

  // Sequential arrows
  for(let i=1;i<nodePositions.length;i++){
    const from=nodePositions[i-1], to=nodePositions[i];
    const fx=from.x+nodeW, fy=from.y+nodeH/2;
    const tx=to.x, ty=to.y+nodeH/2;
    if(from.y===to.y){
      h+='<line x1="'+fx+'" y1="'+fy+'" x2="'+tx+'" y2="'+ty+'" stroke="#2A2433" stroke-width="2" marker-end="url(#bpmn-arrow)"/>';
    } else {
      const mx=(fx+tx)/2;
      h+='<path d="M'+fx+','+fy+' C'+mx+','+fy+' '+mx+','+ty+' '+tx+','+ty+'" fill="none" stroke="#2A2433" stroke-width="2" marker-end="url(#bpmn-arrow)"/>';
    }
  }

  // Arrow marker
  h+='<defs><marker id="bpmn-arrow" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#4A8FE0"/></marker></defs>';

  // Start circle
  if(nodePositions.length>0){
    const first=nodePositions[0];
    h+='<circle cx="'+(first.x-25)+'" cy="'+(first.y+nodeH/2)+'" r="12" fill="#3DB86A"/>';
    h+='<line x1="'+(first.x-13)+'" y1="'+(first.y+nodeH/2)+'" x2="'+first.x+'" y2="'+(first.y+nodeH/2)+'" stroke="#3DB86A" stroke-width="2" marker-end="url(#bpmn-arrow)"/>';
    // End circle
    const last=nodePositions[nodePositions.length-1];
    h+='<circle cx="'+(last.x+nodeW+25)+'" cy="'+(last.y+nodeH/2)+'" r="12" fill="#D44040"/>';
    h+='<line x1="'+(last.x+nodeW)+'" y1="'+(last.y+nodeH/2)+'" x2="'+(last.x+nodeW+13)+'" y2="'+(last.y+nodeH/2)+'" stroke="#D44040" stroke-width="2"/>';
  }
  h+='</svg>';

  // Draw HTML nodes
  laneNames.forEach((lane,li)=>{
    lanes[lane].forEach((proc,ni)=>{
      const x=padX+60+ni*gapX;
      const y=padY+li*laneH+(laneH-nodeH)/2;
      const p=processes[proc.pi];
      // Find A (accountable)
      let accountable='';
      p.v.forEach((val,vi)=>{ if(val==='A') accountable=r.roles[vi]; });
      h+='<div class="bpmn-node" style="left:'+x+'px;top:'+y+'px;width:'+nodeW+'px;height:'+nodeH+'px" onclick="goToRaciProcess('+proc.pi+')" title="Клик — открыть в RACI">';
      h+='<div class="bn-type">R: '+proc.owner+'</div>';
      h+='<div class="bn-name">'+proc.name+'</div>';
      if(accountable) h+='<div class="bn-owner">A: '+accountable+'</div>';
      h+='</div>';
    });
  });
  h+='</div>';
  h+='<div style="margin-top:12px;font-size:11px;color:var(--text3)">Процессы сгруппированы по swim-lanes (ответственный R). Клик на блок — переход к RACI.</div>';
  document.getElementById('bpmn-content').innerHTML=h;
}

function goToRaciProcess(pi){
  // Switch to RACI tab and highlight the process
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelector('[data-section="raci"]').classList.add('active');
  document.getElementById('section-raci').classList.add('active');
  raciFilter='';
  renderRaci();
  // Scroll to and highlight the row
  setTimeout(()=>{
    const rows=document.querySelectorAll('#raci-content tbody tr');
    if(rows[pi]){rows[pi].style.background='rgba(201,164,76,0.15)';rows[pi].scrollIntoView({behavior:'smooth',block:'center'});}
  },100);
}

function renderBudget(){
  const b=STATE.budget;
  let h='<div class="budget-grid">';
  h+='<div class="budget-card"><div class="budget-amount">'+(b.grandTotal/1e6).toFixed(1)+' млн &#8381;</div><div class="budget-label">Общий бюджет (18 мес)</div></div>';
  h+='<div class="budget-card"><div class="budget-amount" style="color:var(--green)">0.03%</div><div class="budget-label">от портфеля (7.5 млрд)</div></div>';
  h+='<div class="budget-card"><div class="budget-amount" style="color:var(--blue)">18</div><div class="budget-label">месяцев</div></div>';
  h+='<div class="budget-card"><div class="budget-amount" style="color:var(--purple)">6</div><div class="budget-label">фаз</div></div></div>';

  // SVG donut chart
  h+='<div style="display:flex;gap:24px;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap">';
  h+='<div style="flex-shrink:0">';
  const colors=['var(--text3)','var(--green)','var(--blue)','var(--purple)','var(--orange)','var(--gold)','var(--cyan)'];
  const colorHex=['#6B6573','#3DB86A','#4A8FE0','#8B5CF6','#E89B3A','#C9A44C','#38BDF8'];
  let total=b.grandTotal||1;
  let cumAngle=0;
  h+='<svg width="200" height="200" viewBox="0 0 200 200">';
  b.phases.forEach((ph,i)=>{
    if(ph.total<=0)return;
    const angle=(ph.total/total)*360;
    const startAngle=cumAngle;
    const endAngle=cumAngle+angle;
    const x1=100+70*Math.cos((startAngle-90)*Math.PI/180);
    const y1=100+70*Math.sin((startAngle-90)*Math.PI/180);
    const x2=100+70*Math.cos((endAngle-90)*Math.PI/180);
    const y2=100+70*Math.sin((endAngle-90)*Math.PI/180);
    const largeArc=angle>180?1:0;
    h+=`<path d="M100,100 L${x1},${y1} A70,70 0 ${largeArc},1 ${x2},${y2} Z" fill="${colorHex[i+1]||colorHex[1]}" opacity="0.8" stroke="var(--bg)" stroke-width="2"/>`;
    cumAngle=endAngle;
  });
  h+='<circle cx="100" cy="100" r="40" fill="var(--bg)"/>';
  h+='<text x="100" y="96" text-anchor="middle" fill="var(--gold)" font-size="14" font-weight="700">'+(total/1e6).toFixed(1)+'М</text>';
  h+='<text x="100" y="112" text-anchor="middle" fill="var(--text3)" font-size="10">руб</text>';
  h+='</svg></div>';
  h+='<div style="flex:1;min-width:200px">';
  b.phases.forEach((ph,i)=>{
    if(ph.total<=0)return;
    const pct=((ph.total/total)*100).toFixed(0);
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><div style="width:10px;height:10px;border-radius:50%;background:'+colorHex[i+1]+';flex-shrink:0"></div><span style="font-size:12px;flex:1">'+ph.name+'</span><span style="font-size:12px;font-weight:700;color:'+colorHex[i+1]+'">'+ph.total.toLocaleString('ru-RU')+' &#8381; ('+pct+'%)</span></div>';
  });
  h+='</div></div>';

  h+='<table class="data-table"><thead><tr><th>Фаза</th><th>Период</th><th>Статья</th><th>Сумма</th></tr></thead><tbody>';
  b.phases.forEach(ph=>{
    ph.items.forEach((it,i)=>{
      h+='<tr>';
      if(i===0)h+='<td rowspan="'+ph.items.length+'" style="font-weight:600">'+ph.name+'</td><td rowspan="'+ph.items.length+'">'+ph.months+'</td>';
      h+='<td>'+it.name+'</td><td style="color:var(--gold)">'+(it.cost?it.cost.toLocaleString('ru-RU')+' &#8381;':'&mdash;')+'</td></tr>';
    });
    h+='<tr style="background:var(--card2)"><td colspan="3" style="text-align:right;font-weight:600">Итого:</td><td style="color:var(--gold);font-weight:700">'+ph.total.toLocaleString('ru-RU')+' &#8381;</td></tr>';
  });
  h+='</tbody></table>';
  document.getElementById('budget-content').innerHTML=h;
}

function renderRisks(){
  let h='';

  // Risk matrix
  h+='<h3 style="margin-bottom:12px">Матрица рисков</h3>';
  h+='<div class="risk-matrix">';
  h+='<div class="rm-cell rm-header"></div><div class="rm-cell rm-header">Низкая<br>вероятность</div><div class="rm-cell rm-header">Средняя<br>вероятность</div><div class="rm-cell rm-header">Высокая<br>вероятность</div>';
  h+='<div class="rm-cell rm-header">Высокий<br>ущерб</div><div class="rm-cell rm-medium"></div><div class="rm-cell rm-high">Конфликт зон</div><div class="rm-cell rm-high">Сопротивление</div>';
  h+='<div class="rm-cell rm-header">Средний<br>ущерб</div><div class="rm-cell rm-low">Maison Rouge</div><div class="rm-cell rm-medium">Потеря людей<br>Нет рук-лей</div><div class="rm-cell rm-medium">Затяжка строек</div>';
  h+='<div class="rm-cell rm-header">Низкий<br>ущерб</div><div class="rm-cell rm-low"></div><div class="rm-cell rm-low">IT-система</div><div class="rm-cell rm-medium">Вмешательство</div>';
  h+='</div>';

  // Risk cards
  h+='<h3 style="margin:24px 0 12px">Реестр рисков ('+STATE.risks.length+')</h3>';
  h+='<div class="risk-grid">';
  STATE.risks.forEach((r,i)=>{
    h+='<div class="risk-card">';
    h+='<div class="rc-header"><span class="rc-title">'+r.title+'</span><span class="rc-level '+r.level+'">'+r.level.toUpperCase()+'</span></div>';
    h+='<div class="rc-desc">'+r.desc+'</div>';
    h+='<div class="rc-mitigation">'+r.mitigation+'</div>';
    h+='</div>';
  });
  h+='</div>';

  document.getElementById('risks-content').innerHTML=h;
}

function renderFaq(){
  let h='';
  STATE.faq.forEach(f=>{h+='<div class="faq-item" onclick="this.classList.toggle(\'open\')"><div class="faq-q">'+f.q+'</div><div class="faq-a">'+f.a+'</div></div>'});
  document.getElementById('faq-content').innerHTML=h;
}

function renderFrameworks(){
  let h='';
  h+='<div class="fw-card"><h4>Galbraith Star Model</h4><p style="font-size:13px;color:var(--text2);margin-bottom:10px">5 элементов организационного дизайна, которые должны быть согласованы.</p><ul>';
  h+='<li><strong style="color:var(--gold)">Strategy</strong> &mdash; Family Office, портфельное управление</li>';
  h+='<li><strong style="color:var(--gold)">Structure</strong> &mdash; 3 блока: Инвестиции, Девелопмент, Операции</li>';
  h+='<li><strong style="color:var(--gold)">Processes</strong> &mdash; Регламенты, отчётность, инвесткомитет</li>';
  h+='<li><strong style="color:var(--gold)">Rewards</strong> &mdash; KPI + фикс + бонус + % от прироста</li>';
  h+='<li><strong style="color:var(--gold)">People</strong> &mdash; Выращивание руководителей, найм</li></ul></div>';
  h+='<div class="fw-card"><h4>Kotter\'s 8 Steps</h4><p style="font-size:13px;color:var(--text2);margin-bottom:10px">Как проводить изменения без сопротивления.</p><ul>';
  ['Создать срочность &rarr; &laquo;Риск бездействия выше&raquo;','Команда изменений &rarr; Никита + Владимир','Видение &rarr; Family Office','Коммуникация &rarr; Выступление перед командой','Устранить препятствия &rarr; Снять перегрузку','Быстрые победы &rarr; Первые 30 дней','Закрепить &rarr; KPI, регламенты','Встроить в культуру &rarr; Family Council'].forEach((s,i)=>{h+='<li><strong style="color:var(--gold)">'+(i+1)+'.</strong> '+s+'</li>'});
  h+='</ul></div>';
  h+='<div class="fw-card"><h4>RACI</h4><p style="font-size:13px;color:var(--text2)"><strong>R</strong>esponsible &mdash; выполняет. <strong>A</strong>ccountable &mdash; решает (один!). <strong>C</strong>onsulted &mdash; согласовывает. <strong>I</strong>nformed &mdash; информируется.</p></div>';
  h+='<div class="fw-card"><h4>Family Office &mdash; принципы</h4><ul style="font-size:13px;color:var(--text2);line-height:1.8">';
  h+='<li>Управляет <strong>капиталом</strong>, не объектами</li><li>Собственники = стратегия, не операционка</li><li>Инвесткомитет = орган решений</li><li>Family Council = долгосрочная стратегия + наследование</li><li>Ядро 12-18 чел., остальное &mdash; подрядчики</li><li>Мотивация = рост капитала</li></ul></div>';
  document.getElementById('frameworks-content').innerHTML=h;
}

// ============================================================
// FIREBASE REAL-TIME SYNC
// ============================================================
const FB_URL = 'https://nikfgdg5trg-default-rtdb.firebaseio.com';
const SESSION_ID = 'user_' + Math.random().toString(36).substr(2, 6);
let saveTimer = null;
let ignoreNext = false;
let eventSource = null;
let lastSaveTs = 0;

function setSyncStatus(status, text) {
  const bar = document.getElementById('sync-bar');
  const txt = document.getElementById('sync-text');
  if (bar) bar.className = status;
  if (txt) txt.textContent = text;
}

function syncToFirebase() {
  if (saveTimer) clearTimeout(saveTimer);
  setSyncStatus('saving', 'Сохраняю...');
  saveTimer = setTimeout(() => {
    lastSaveTs = Date.now();
    const payload = JSON.stringify({
      state: STATE,
      editor: SESSION_ID,
      ts: lastSaveTs
    });
    fetch(FB_URL + '/project.json', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: payload
    })
    .then(r => { if (r.ok) setSyncStatus('saved', 'Сохранено'); else setSyncStatus('error', 'Ошибка сохранения'); })
    .catch(() => setSyncStatus('error', 'Нет соединения'));
  }, 600);
}

function loadFromFirebase(callback) {
  fetch(FB_URL + '/project.json')
    .then(r => r.json())
    .then(snap => {
      if (snap && snap.state) {
        Object.assign(STATE.trees, snap.state.trees || {});
        Object.assign(STATE.delta, snap.state.delta || {});
        Object.assign(STATE.gantt, snap.state.gantt || {});
        Object.assign(STATE.raci, snap.state.raci || {});
        Object.assign(STATE.budget, snap.state.budget || {});
        if (snap.state.risks) STATE.risks = snap.state.risks;
        if (snap.state.faq) STATE.faq = snap.state.faq;
        setSyncStatus('synced', 'Синхронизировано');
      }
      if (callback) callback();
    })
    .catch(() => {
      setSyncStatus('offline', 'Офлайн — работаю локально');
      if (callback) callback();
    });
}

function startRealtimeListener() {
  if (eventSource) eventSource.close();
  eventSource = new EventSource(FB_URL + '/project.json');

  eventSource.addEventListener('put', function(e) {
    try {
      const msg = JSON.parse(e.data);
      if (msg.path === '/' && msg.data && msg.data.editor !== SESSION_ID) {
        // Someone else made a change
        if (msg.data.ts && msg.data.ts <= lastSaveTs) return; // stale
        ignoreNext = true;
        Object.assign(STATE.trees, msg.data.state.trees || {});
        Object.assign(STATE.delta, msg.data.state.delta || {});
        Object.assign(STATE.gantt, msg.data.state.gantt || {});
        Object.assign(STATE.raci, msg.data.state.raci || {});
        Object.assign(STATE.budget, msg.data.state.budget || {});
        if (msg.data.state.risks) STATE.risks = msg.data.state.risks;
        if (msg.data.state.faq) STATE.faq = msg.data.state.faq;
        renderAll(true);
        setSyncStatus('synced', 'Обновлено от ' + msg.data.editor);
        setTimeout(() => { ignoreNext = false; }, 100);
      } else if (msg.path === '/' && msg.data && msg.data.editor === SESSION_ID) {
        setSyncStatus('saved', 'Сохранено');
      }
    } catch(err) {
      console.warn('Firebase parse error:', err);
    }
  });

  eventSource.addEventListener('patch', function(e) {
    try {
      const msg = JSON.parse(e.data);
      if (msg.data && msg.data.editor !== SESSION_ID) {
        loadFromFirebase(() => renderAll(true));
      }
    } catch(err) {}
  });

  eventSource.onerror = function() {
    setSyncStatus('offline', 'Переподключение...');
    setTimeout(() => {
      if (eventSource.readyState === 2) startRealtimeListener();
    }, 3000);
  };

  eventSource.onopen = function() {
    setSyncStatus('synced', 'Подключено');
  };
}

// Track online presence with names
const USER_COLORS = ['#4A8FE0','#3DB86A','#8B5CF6','#E89B3A','#D44040','#38BDF8','#C9A44C','#E0608A'];
const MY_COLOR = USER_COLORS[Math.floor(Math.random()*USER_COLORS.length)];
let myName = localStorage.getItem('gk_username') || '';

function promptName() {
  if (!myName) {
    myName = prompt('Введите ваше имя (видно коллегам):','') || 'Аноним';
    localStorage.setItem('gk_username', myName);
  }
}

function updatePresence() {
  fetch(FB_URL + '/presence/' + SESSION_ID + '.json', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ts: Date.now(),
      id: SESSION_ID,
      name: myName,
      color: MY_COLOR,
      page: document.querySelector('.nav-btn.active')?.dataset?.section || 'dashboard'
    })
  }).catch(() => {});
}

function checkOnlineUsers() {
  fetch(FB_URL + '/presence.json')
    .then(r => r.json())
    .then(data => {
      if (!data) return;
      const now = Date.now();
      const users = Object.values(data).filter(u => now - u.ts < 30000);
      users.sort((a,b) => a.id === SESSION_ID ? -1 : b.id === SESSION_ID ? 1 : 0);

      const countEl = document.getElementById('pp-count');
      const listEl = document.getElementById('presence-list');
      if (countEl) {
        countEl.textContent = users.length;
        countEl.style.background = users.length > 1 ? 'var(--green)' : 'var(--text3)';
      }
      if (listEl) {
        const pageNames = {
          dashboard:'Dashboard', asis:'AS-IS', transition:'Переходная', target:'Целевая',
          delta:'Дельта', gantt:'Гант', raci:'RACI', bpmn:'Процессы', budget:'Бюджет',
          risks:'Риски', faq:'FAQ', frameworks:'Фреймворки'
        };
        listEl.innerHTML = users.map(u => {
          const isMe = u.id === SESSION_ID;
          const initials = (u.name||'?').split(' ').map(w=>w[0]).join('').toUpperCase().substr(0,2);
          const page = pageNames[u.page] || u.page || '';
          return `<div class="presence-user${isMe?' you':''}">
            <div class="pu-dot"></div>
            <div class="pu-avatar" style="background:${u.color||'var(--blue)'}">${initials}</div>
            <div><div class="pu-name">${u.name||'Аноним'}</div><div class="pu-status">Смотрит: ${page}</div></div>
          </div>`;
        }).join('');
      }
    })
    .catch(() => {});
}

// Clean up stale presence on page close
window.addEventListener('beforeunload', () => {
  navigator.sendBeacon(FB_URL + '/presence/' + SESSION_ID + '.json', 'null');
});

// ============================================================
// RENDER ALL
// ============================================================
function renderAll(fromRemote) {
  renderDashboard();
  renderTree('tree-asis', STATE.trees.asis, 'asis');
  renderTree('tree-transition', STATE.trees.transition, 'transition');
  renderTree('tree-target', STATE.trees.target, 'target');
  renderDelta();
  renderGantt();
  renderRaci();
  renderBpmn();
  renderBudget();
  renderRisks();
  renderFaq();
  renderFrameworks();
  if (!fromRemote && !ignoreNext) syncToFirebase();
}

// ============================================================
// INIT: Load from Firebase, then render, then listen
// ============================================================
// Also track which page user is viewing for presence
document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>{ setTimeout(updatePresence, 100); }));

setSyncStatus('connecting', 'Подключение к Firebase...');
promptName();
loadFromFirebase(() => {
  renderAll(true);
  startRealtimeListener();
  updatePresence();
  checkOnlineUsers();
  setInterval(updatePresence, 10000);
  setInterval(checkOnlineUsers, 5000);
});
</script>
</body>
</html>
